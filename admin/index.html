<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - GestionArte</title>

    <!-- Cargar config.js -->
    <script src="../config.js"></script>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <style>
        /* ============================================
           VARIABLES CSS
           ============================================ */
        :root {
            --primary-color: #1D4E4F;
            --secondary-color: #2D8B7A;
            --tertiary-color: #5FB09C;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* ============================================
           HEADER
           ============================================ */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* ============================================
           LAYOUT PRINCIPAL
           ============================================ */
        .main-container {
            display: flex;
            flex: 1;
        }
        
        /* ============================================
           SIDEBAR
           ============================================ */
        .sidebar {
            width: 220px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 1rem 0;
        }
        
        .nav-item {
            display: block;
            padding: 0.75rem 1.5rem;
            color: #495057;
            text-decoration: none;
            font-size: 0.95rem;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .nav-item:hover {
            background: #e9ecef;
            color: var(--primary-color);
        }
        
        .nav-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        .nav-item i {
            margin-right: 0.5rem;
            width: 20px;
        }
        
        .nav-divider {
            height: 1px;
            background: #dee2e6;
            margin: 0.75rem 1rem;
        }
        
        .nav-label {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #6c757d;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        /* ============================================
           CONTENT AREA
           ============================================ */
        .content {
            flex: 1;
            padding: 2rem;
            background: #fff;
            overflow-y: auto;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .content-header h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        /* ============================================
           BOTONES
           ============================================ */
        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary:hover {
            background: var(--secondary-color);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-action {
            background: none;
            border: 1px solid #dee2e6;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 0.25rem;
            transition: all 0.2s;
        }
        
        .btn-action:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* ============================================
           STATS CARDS
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-card.warning {
            border-left-color: #ffc107;
        }
        
        .stat-card.success {
            border-left-color: #28a745;
        }
        
        .stat-card.info {
            border-left-color: var(--secondary-color);
        }
        
        .stat-card.danger {
            border-left-color: #dc3545;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* ============================================
           TABLAS
           ============================================ */
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .table-header h3 {
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .table-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 0.4rem 0.8rem;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* ============================================
           BADGES
           ============================================ */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-progress {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-resolved, .badge-success, .badge-active {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-closed {
            background: #e9ecef;
            color: #495057;
        }
        
        .badge-danger, .badge-suspended {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-grace {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-soporte {
            background: rgba(29, 78, 79, 0.1);
            color: var(--primary-color);
        }
        
        .badge-modificacion {
            background: rgba(45, 139, 122, 0.1);
            color: var(--secondary-color);
        }
        
        /* Bandas de precio */
        .badge-indigo {
            background: rgba(99, 102, 241, 0.15);
            color: #4f46e5;
        }
        
        .badge-naranja {
            background: rgba(251, 146, 60, 0.15);
            color: #ea580c;
        }
        
        .badge-verde {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }
        
        .badge-azul {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
        }

        /* ============================================
           QUILL EDITOR
           ============================================ */
        .quill-container {
            background: white;
            border-radius: 6px;
        }
        
        #update-detail-editor {
            min-height: 200px;
            border: 1px solid #dee2e6;
            border-radius: 0 0 6px 6px;
        }
        
        .ql-toolbar {
            border-radius: 6px 6px 0 0;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        
        .ql-editor {
            min-height: 200px;
            font-size: 0.95rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* ============================================
           CONFIGURACI칍N
           ============================================ */
        .config-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .config-section {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .config-section:last-child {
            border-bottom: none;
        }
        
        .config-section h3 {
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .color-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .color-input-group input[type="color"] {
            width: 50px;
            height: 38px;
            padding: 2px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .color-input-group input[type="text"] {
            flex: 1;
        }
        
        .color-preview {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .color-swatch {
            width: 80px;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .config-actions {
            padding: 1.5rem;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .switch-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        .notification-fields {
            display: none;
        }
        
        .notification-fields.show {
            display: block;
        }
        
        /* ============================================
           ALERTAS
           ============================================ */
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        /* ============================================
           EMPTY STATE
           ============================================ */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* ============================================
           FOOTER
           ============================================ */
        footer {
            background: var(--primary-color);
            color: white;
            text-align: center;
            padding: 1rem;
        }
        
        footer p {
            margin: 0;
            font-size: 0.85rem;
        }
        
        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 992px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                display: flex;
                overflow-x: auto;
                padding: 0.5rem;
            }
            
            .nav-item {
                white-space: nowrap;
                padding: 0.5rem 1rem;
            }
            
            .nav-divider, .nav-label {
                display: none;
            }
            
            .content {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            th, td {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .modal {
                width: 95%;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>

    <!-- ============================================
         HEADER
         ============================================ -->
    <header class="header">
        <h1><i class="bi bi-gear-fill"></i> <span id="site-name">GestionArte</span> - Admin</h1>
        <div class="header-right">
            <span class="user-info">Hola, <strong id="user-name">Usuario</strong></span>
            <button class="btn-logout" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> Salir
            </button>
        </div>
    </header>

    <div class="main-container">

    <!-- ============================================
             SIDEBAR
             ============================================ -->
        <nav class="sidebar">
            <button class="nav-item active" data-section="dashboard">
                <i class="bi bi-speedometer2"></i> Dashboard
            </button>
            <div class="nav-divider"></div>
            <div class="nav-label">Gesti칩n</div>
            <button class="nav-item" data-section="clientes">
                <i class="bi bi-building"></i> Clientes
            </button>
            <button class="nav-item" data-section="renovaciones">
                <i class="bi bi-credit-card"></i> Renovaciones
            </button>
            <button class="nav-item" data-section="comisiones">
                <i class="bi bi-cash-stack"></i> Comisiones
            </button>
            <div class="nav-divider"></div>
            <div class="nav-label">Soporte</div>
            <button class="nav-item" data-section="solicitudes">
                <i class="bi bi-ticket-detailed"></i> Solicitudes
            </button>
            <button class="nav-item" data-section="actualizaciones">
                <i class="bi bi-megaphone"></i> Actualizaciones
            </button>
            <div class="nav-divider"></div>
            <div class="nav-label">Sistema</div>
            <button class="nav-item" data-section="usuarios">
                <i class="bi bi-people"></i> Usuarios
            </button>
            <button class="nav-item" data-section="catalogos">
                <i class="bi bi-collection"></i> Cat치logos
            </button>
            <button class="nav-item" data-section="migraciones">
                <i class="bi bi-database-gear"></i> Migraciones
            </button>
            <button class="nav-item" data-section="configuracion">
                <i class="bi bi-sliders"></i> Configuraci칩n
            </button>
        </nav>

        <!-- ============================================
             CONTENT AREA
             ============================================ -->
        <main class="content">
        
            <!-- ============================================
                 SECCI칍N: DASHBOARD
                 ============================================ -->
            <section id="section-dashboard">
                <div class="content-header">
                    <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
                    <span style="color: #6c757d; font-size: 0.9rem;" id="dashboard-date"></span>
                </div>
                
                <!-- Stats principales -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="dash-total-clientes">0</div>
                        <div class="stat-label">Total Clientes</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number" id="dash-clientes-activos">0</div>
                        <div class="stat-label">Activos</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="dash-por-vencer">0</div>
                        <div class="stat-label">Por Vencer (30 d칤as)</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-number" id="dash-vencidos">0</div>
                        <div class="stat-label">Vencidos / Suspendidos</div>
                    </div>
                </div>
                
                <!-- Fila de ingresos y comisiones -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3><i class="bi bi-graph-up-arrow"></i> Ingresos del Mes</h3>
                        </div>
                        <div style="padding: 2rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary-color);" id="dash-ingresos-mes">$0</div>
                            <div style="color: #6c757d; margin-top: 0.5rem;">USD recaudados</div>
                            <div style="margin-top: 1rem; font-size: 0.9rem;">
                                <span id="dash-pagos-mes">0</span> pagos registrados
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3><i class="bi bi-wallet2"></i> Comisiones Pendientes</h3>
                        </div>
                        <div style="padding: 2rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #ffc107;" id="dash-comisiones-pendientes">$0</div>
                            <div style="color: #6c757d; margin-top: 0.5rem;">USD por liquidar</div>
                            <div style="margin-top: 1rem;">
                                <a href="#" onclick="switchSection('comisiones'); return false;" style="color: var(--secondary-color); text-decoration: none; font-size: 0.9rem;">
                                    Ver detalle <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Fila de distribuci칩n -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <!-- Por Pa칤s -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3><i class="bi bi-globe-americas"></i> Clientes por Pa칤s</h3>
                        </div>
                        <div style="padding: 1rem;" id="dash-por-pais">
                            <div class="empty-state" style="padding: 1rem;">
                                <i class="bi bi-hourglass-split"></i>
                                <p>Cargando...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Por Canal -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3><i class="bi bi-diagram-3"></i> Clientes por Canal</h3>
                        </div>
                        <div style="padding: 1rem;" id="dash-por-canal">
                            <div class="empty-state" style="padding: 1rem;">
                                <i class="bi bi-hourglass-split"></i>
                                <p>Cargando...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Fila de tipos y pr칩ximos a vencer -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Por Tipo -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3><i class="bi bi-tags"></i> Clientes por Tipo</h3>
                        </div>
                        <div style="padding: 1rem;" id="dash-por-tipo">
                            <div class="empty-state" style="padding: 1rem;">
                                <i class="bi bi-hourglass-split"></i>
                                <p>Cargando...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pr칩ximos a vencer -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3><i class="bi bi-exclamation-triangle"></i> Pr칩ximos a Vencer</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Pa칤s</th>
                                    <th>Vence</th>
                                    <th>D칤as</th>
                                </tr>
                            </thead>
                            <tbody id="dash-proximos-vencer">
                                <tr>
                                    <td colspan="4">
                                        <div class="empty-state" style="padding: 1rem;">
                                            <p>Cargando...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            <!-- ============================================
                 SECCI칍N: CLIENTES
                 ============================================ -->
            <section id="section-clientes" style="display: none;">
                <div class="content-header">
                    <h2><i class="bi bi-building"></i> Clientes</h2>
                    <button class="btn-primary" onclick="openModal('client')">
                        <i class="bi bi-plus-lg"></i> Nuevo Cliente
                    </button>
                </div>
                
                <!-- Stats de clientes -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="stat-clientes-total">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number" id="stat-clientes-activos">0</div>
                        <div class="stat-label">Activos</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="stat-clientes-gracia">0</div>
                        <div class="stat-label">En Gracia</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-number" id="stat-clientes-suspendidos">0</div>
                        <div class="stat-label">Suspendidos</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Listado de Clientes</h3>
                        <div class="table-filters">
                            <select class="filter-select" id="filter-client-country">
                                <option value="">Todos los pa칤ses</option>
                            </select>
                            <select class="filter-select" id="filter-client-type">
                                <option value="">Todos los tipos</option>
                            </select>
                            <select class="filter-select" id="filter-client-channel">
                                <option value="">Todos los canales</option>
                            </select>
                            <select class="filter-select" id="filter-client-status">
                                <option value="">Todos los estados</option>
                                <option value="pending">Pendiente</option>
                                <option value="active">Activo</option>
                                <option value="grace_period">En Gracia</option>
                                <option value="suspended">Suspendido</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                            <input type="text" class="filter-select" id="filter-client-search" placeholder="Buscar..." style="width: 150px;">
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Organizaci칩n</th>
                                <th>Pa칤s</th>
                                <th>Tipo</th>
                                <th>Canal</th>
                                <th>Precio USD</th>
                                <th>Vence</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-clientes">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ============================================
                 SECCI칍N: RENOVACIONES
                 ============================================ -->
            <section id="section-renovaciones" style="display: none;">
                <div class="content-header">
                    <h2><i class="bi bi-credit-card"></i> Renovaciones y Pagos</h2>
                    <button class="btn-primary" onclick="openModal('renewal')">
                        <i class="bi bi-plus-lg"></i> Registrar Pago
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card success">
                        <div class="stat-number" id="stat-pagos-mes-count">0</div>
                        <div class="stat-label">Pagos este mes</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-number" id="stat-ingresos-mes-total">$0</div>
                        <div class="stat-label">Ingresos USD</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="stat-pendientes-pago">0</div>
                        <div class="stat-label">Pendientes de pago</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-renovaciones-anio">0</div>
                        <div class="stat-label">Total a침o</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Historial de Pagos</h3>
                        <div class="table-filters">
                            <select class="filter-select" id="filter-renewal-year">
                                <option value="">Todos los a침os</option>
                                <option value="2026" selected>2026</option>
                                <option value="2025">2025</option>
                            </select>
                            <select class="filter-select" id="filter-renewal-month">
                                <option value="">Todos los meses</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                            <select class="filter-select" id="filter-renewal-status">
                                <option value="">Todos los estados</option>
                                <option value="paid">Pagados</option>
                                <option value="pending">Pendientes</option>
                                <option value="overdue">Vencidos</option>
                            </select>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Cliente</th>
                                <th>Per칤odo</th>
                                <th>Monto USD</th>
                                <th>M칠todo</th>
                                <th>Estado</th>
                                <th>Fecha Pago</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-renovaciones">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ============================================
                 SECCI칍N: COMISIONES
                 ============================================ -->
            <section id="section-comisiones" style="display: none;">
                <div class="content-header">
                    <h2><i class="bi bi-cash-stack"></i> Liquidaci칩n de Comisiones</h2>
                    <button class="btn-primary" onclick="calculateCommissions()">
                        <i class="bi bi-calculator"></i> Calcular Comisiones
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card info">
                        <div class="stat-number" id="stat-ventas-periodo">$0</div>
                        <div class="stat-label">Ventas del per칤odo</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="stat-comisiones-calculadas">$0</div>
                        <div class="stat-label">Comisiones calculadas</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number" id="stat-comisiones-pagadas-total">$0</div>
                        <div class="stat-label">Comisiones pagadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-comisiones-pendientes-total">$0</div>
                        <div class="stat-label">Pendientes pago</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Comisiones por Canal</h3>
                        <div class="table-filters">
                            <select class="filter-select" id="filter-commission-year">
                                <option value="2026" selected>2026</option>
                                <option value="2025">2025</option>
                            </select>
                            <select class="filter-select" id="filter-commission-month">
                                <option value="">Todos los meses</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                            <select class="filter-select" id="filter-commission-status">
                                <option value="">Todos los estados</option>
                                <option value="calculated">Calculadas</option>
                                <option value="approved">Aprobadas</option>
                                <option value="paid">Pagadas</option>
                            </select>
                            <select class="filter-select" id="filter-commission-channel">
                                <option value="">Todos los canales</option>
                            </select>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-commissions"></th>
                                <th>Canal</th>
                                <th>Cliente</th>
                                <th>Venta USD</th>
                                <th>% Comisi칩n</th>
                                <th>Comisi칩n USD</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-comisiones">
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button class="btn-secondary" onclick="exportCommissions()">
                        <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                    </button>
                    <button class="btn-success" onclick="markCommissionsAsPaid()">
                        <i class="bi bi-check-all"></i> Marcar Seleccionadas como Pagadas
                    </button>
                </div>
            </section>
            <!-- ============================================
                 SECCI칍N: SOLICITUDES
                 ============================================ -->
            <section id="section-solicitudes" style="display: none;">
                <div class="content-header">
                    <h2><i class="bi bi-ticket-detailed"></i> Solicitudes de Soporte</h2>
                </div>
                
                <div class="stats-grid" id="stats-solicitudes">
                    <div class="stat-card warning">
                        <div class="stat-number" id="stat-pendientes">0</div>
                        <div class="stat-label">Pendientes</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-number" id="stat-proceso">0</div>
                        <div class="stat-label">En Proceso</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number" id="stat-resueltas">0</div>
                        <div class="stat-label">Resueltas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-total">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Listado de Solicitudes</h3>
                        <div class="table-filters">
                            <select class="filter-select" id="filter-status">
                                <option value="">Todos los estados</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="en_proceso">En Proceso</option>
                                <option value="resuelto">Resuelto</option>
                                <option value="cerrado">Cerrado</option>
                            </select>
                            <select class="filter-select" id="filter-type">
                                <option value="">Todos los tipos</option>
                                <option value="soporte">Soporte</option>
                                <option value="modificacion">Modificaci칩n</option>
                            </select>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Cliente</th>
                                <th>Tipo</th>
                                <th>Descripci칩n</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-solicitudes">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ============================================
                 SECCI칍N: ACTUALIZACIONES
                 ============================================ -->
            <section id="section-actualizaciones" style="display: none;">
                <div class="content-header">
                    <h2><i class="bi bi-megaphone"></i> Actualizaciones del Sistema</h2>
                    <button class="btn-primary" onclick="openModal('update')">
                        <i class="bi bi-plus-lg"></i> Nueva Actualizaci칩n
                    </button>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Listado de Actualizaciones</h3>
                        <div class="table-filters">
                            <select class="filter-select" id="filter-module">
                                <option value="">Todos los m칩dulos</option>
                            </select>
                            <select class="filter-select" id="filter-published">
                                <option value="">Todos</option>
                                <option value="true">Publicados</option>
                                <option value="false">Borradores</option>
                            </select>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>M칩dulo</th>
                                <th>Funcionalidad</th>
                                <th>Versi칩n</th>
                                <th>Detalle</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-actualizaciones">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ============================================
                 SECCI칍N: USUARIOS
                 ============================================ -->
            <section id="section-usuarios" style="display: none;">
                <div class="content-header">
                    <h2><i class="bi bi-people"></i> Usuarios del Sistema</h2>
                    <button class="btn-primary" onclick="openModal('user')">
                        <i class="bi bi-plus-lg"></i> Nuevo Usuario
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>칔ltimo acceso</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-usuarios">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ============================================
                 SECCI칍N: CAT츼LOGOS
                 ============================================ -->
            <section id="section-catalogos" style="display: none;">
                <div class="content-header">
                    <h2><i class="bi bi-collection"></i> Cat치logos</h2>
                </div>
                
                <!-- Sub-navegaci칩n de cat치logos -->
                <div class="catalog-tabs">
                    <button class="catalog-tab active" data-catalog="paises">
                        <i class="bi bi-globe-americas"></i> Pa칤ses y Tarifas
                    </button>
                    <button class="catalog-tab" data-catalog="tipos">
                        <i class="bi bi-tags"></i> Tipos de Cliente
                    </button>
                    <button class="catalog-tab" data-catalog="alianzas">
                        <i class="bi bi-handshake"></i> Alianzas
                    </button>
                    <button class="catalog-tab" data-catalog="canales">
                        <i class="bi bi-diagram-3"></i> Canales de Venta
                    </button>
                </div>
                
                <!-- Cat치logo: Pa칤ses -->
                <div id="catalog-paises" class="catalog-content">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>游깵 Pa칤ses y Tarifas</h3>
                            <button class="btn-primary" onclick="openModal('country')">
                                <i class="bi bi-plus-lg"></i> Agregar Pa칤s
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Pa칤s</th>
                                    <th>C칩digo</th>
                                    <th>Precio Anual USD</th>
                                    <th>Banda</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-paises">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Cat치logo: Tipos de Cliente -->
                <div id="catalog-tipos" class="catalog-content" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>游끽 Tipos de Cliente</h3>
                            <button class="btn-primary" onclick="openModal('client-type')">
                                <i class="bi bi-plus-lg"></i> Agregar Tipo
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Icono</th>
                                    <th>C칩digo</th>
                                    <th>Nombre</th>
                                    <th>Descripci칩n</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-tipos">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Cat치logo: Alianzas -->
                <div id="catalog-alianzas" class="catalog-content" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>游뱋 Alianzas</h3>
                            <button class="btn-primary" onclick="openModal('alliance')">
                                <i class="bi bi-plus-lg"></i> Nueva Alianza
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>C칩digo</th>
                                    <th>Nombre</th>
                                    <th>Descuento</th>
                                    <th>Vigencia</th>
                                    <th>Clientes</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-alianzas">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Cat치logo: Canales de Venta -->
                <div id="catalog-canales" class="catalog-content" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>游닊 Canales de Venta</h3>
                            <button class="btn-primary" onclick="openModal('sales-channel')">
                                <i class="bi bi-plus-lg"></i> Nuevo Canal
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>C칩digo</th>
                                    <th>Nombre</th>
                                    <th>Tipo</th>
                                    <th>Comisi칩n</th>
                                    <th>Com. Renovaci칩n</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-canales">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ============================================
         MODALES
         ============================================ -->

    <!-- Modal Ver Solicitud -->
    <div class="modal-overlay" id="modal-view-request">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="bi bi-ticket-detailed"></i> Detalle de Solicitud #<span id="view-request-id"></span></h3>
                <button class="modal-close" onclick="closeModal('view-request')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <strong style="color: #6c757d; font-size: 0.85rem;">Cliente:</strong>
                        <p id="view-client-name" style="margin: 0.25rem 0 0;"></p>
                    </div>
                    <div>
                        <strong style="color: #6c757d; font-size: 0.85rem;">Tipo:</strong>
                        <p id="view-request-type" style="margin: 0.25rem 0 0;"></p>
                    </div>
                    <div>
                        <strong style="color: #6c757d; font-size: 0.85rem;">Estado:</strong>
                        <p id="view-request-status" style="margin: 0.25rem 0 0;"></p>
                    </div>
                    <div>
                        <strong style="color: #6c757d; font-size: 0.85rem;">Fecha:</strong>
                        <p id="view-request-date" style="margin: 0.25rem 0 0;"></p>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #6c757d; font-size: 0.85rem;">Descripci칩n:</strong>
                    <p id="view-request-description" style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin: 0.25rem 0 0;"></p>
                </div>
                
                <div id="view-screenshot-container" style="display: none; margin-bottom: 1rem;">
                    <strong style="color: #6c757d; font-size: 0.85rem;">Captura:</strong>
                    <img id="view-screenshot" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 0.5rem;" src="" alt="Captura">
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e9ecef;">
                
                <div class="form-group">
                    <label>Cambiar Estado</label>
                    <select id="edit-status">
                        <option value="pendiente">Pendiente</option>
                        <option value="en_proceso">En Proceso</option>
                        <option value="resuelto">Resuelto</option>
                        <option value="cerrado">Cerrado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notas Internas</label>
                    <textarea id="edit-notes" placeholder="Notas para el equipo..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('view-request')">Cancelar</button>
                <button class="btn-primary" onclick="updateRequest()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal Cliente (Mejorado) -->
    <div class="modal-overlay" id="modal-client">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3><i class="bi bi-building"></i> <span id="modal-client-title">Nuevo Cliente</span></h3>
                <button class="modal-close" onclick="closeModal('client')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="client-id">
                
                <!-- Informaci칩n de la Organizaci칩n -->
                <div class="form-section-title">
                    <i class="bi bi-building"></i> Informaci칩n de la Organizaci칩n
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre de la Instituci칩n *</label>
                        <input type="text" id="client-name" placeholder="Ej: Universidad del Pac칤fico">
                    </div>
                    <div class="form-group">
                        <label>Raz칩n Social</label>
                        <input type="text" id="client-organization-name" placeholder="Ej: Universidad del Pac칤fico S.A.S.">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>NIT / RFC / RUC</label>
                        <input type="text" id="client-tax-id" placeholder="Ej: 900.123.456-7">
                    </div>
                    <div class="form-group">
                        <label>Rango de Empleados</label>
                        <select id="client-employee-range">
                            <option value="">Seleccione...</option>
                            <option value="1-10">1 - 10</option>
                            <option value="11-50">11 - 50</option>
                            <option value="51-200">51 - 200</option>
                            <option value="201-500">201 - 500</option>
                            <option value="500+">M치s de 500</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Pa칤s *</label>
                        <select id="client-country-id" onchange="updatePriceCalculation()">
                            <option value="">Seleccione un pa칤s...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Organizaci칩n *</label>
                        <select id="client-type-id">
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ciudad</label>
                        <input type="text" id="client-city" placeholder="Ej: Bogot치">
                    </div>
                    <div class="form-group">
                        <label>Tel칠fono</label>
                        <input type="tel" id="client-phone" placeholder="Ej: +57 300 123 4567">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Direcci칩n</label>
                    <input type="text" id="client-address" placeholder="Ej: Calle 100 #15-20, Oficina 501">
                </div>
                
                <!-- Contacto Administrador -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-person-badge"></i> Contacto Administrador
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre del Administrador *</label>
                            <input type="text" id="client-admin-name" placeholder="Ej: Mar칤a Garc칤a">
                        </div>
                        <div class="form-group">
                            <label>Email del Administrador *</label>
                            <input type="email" id="client-email" placeholder="admin@universidad.edu.co">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Email de Facturaci칩n</label>
                        <input type="email" id="client-billing-email" placeholder="facturacion@universidad.edu.co">
                    </div>
                </div>
                
                <!-- Informaci칩n Comercial -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-cart-check"></i> Informaci칩n Comercial
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Canal de Venta *</label>
                            <select id="client-sales-channel-id" onchange="updatePriceCalculation()">
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Alianza (opcional)</label>
                            <select id="client-alliance-id" onchange="updatePriceCalculation()">
                                <option value="">Sin alianza</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Calculadora de Precio -->
                    <div class="price-calculator" id="price-calculator">
                        <h4><i class="bi bi-calculator"></i> C치lculo de Precio</h4>
                        <div class="price-row">
                            <span>Precio base del pa칤s:</span>
                            <span id="calc-base-price">$0.00 USD</span>
                        </div>
                        <div class="price-row" id="calc-discount-row" style="display: none;">
                            <span>Descuento alianza (<span id="calc-discount-percent">0</span>%):</span>
                            <span id="calc-discount-amount">-$0.00 USD</span>
                        </div>
                        <div class="price-row total">
                            <span>PRECIO FINAL ANUAL:</span>
                            <span id="calc-final-price">$0.00 USD</span>
                        </div>
                        <div style="text-align: right; font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem;">
                            ~<span id="calc-monthly-price">$0.00</span> USD/mes
                        </div>
                    </div>
                </div>
                
                <!-- Conexi칩n T칠cnica -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-database"></i> Conexi칩n T칠cnica
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>API Key *</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="client-api-key" placeholder="Llave 칰nica del cliente">
                                <button class="btn-primary" onclick="generateApiKey()" style="white-space: nowrap;">
                                    <i class="bi bi-shuffle"></i> Generar
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>URL de Deployment</label>
                            <input type="url" id="client-deployment-url" placeholder="https://cliente.gestionarte.co">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Supabase URL *</label>
                        <input type="url" id="client-supabase-url" placeholder="https://xxxxx.supabase.co">
                    </div>
                    
                    <div class="form-group">
                        <label>Supabase Anon Key *</label>
                        <input type="text" id="client-supabase-anon-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Supabase Service Role Key</label>
                            <input type="password" id="client-supabase-service-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                            <small><i class="bi bi-shield-lock"></i> Requerida para migraciones autom치ticas</small>
                        </div>
                        <div class="form-group">
                            <label>Postgres Password</label>
                            <input type="password" id="client-postgres-password" placeholder="Contrase침a de la BD">
                            <small><i class="bi bi-database-lock"></i> Se encuentra en Settings  Database</small>
                        </div>
                    </div>
                </div>
                
                <!-- Email del Proyecto -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-envelope"></i> Email del Proyecto
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email del Proyecto</label>
                            <input type="email" id="client-project-email" placeholder="notificaciones@cliente.com">
                            <small><i class="bi bi-info-circle"></i> Email para enviar notificaciones del sistema</small>
                        </div>
                        <div class="form-group">
                            <label>Contrase침a del Email</label>
                            <input type="password" id="client-project-email-password" placeholder="뮉뮉뮉뮉뮉뮉뮉">
                            <small><i class="bi bi-shield-lock"></i> Contrase침a o App Password</small>
                        </div>
                    </div>
                </div>
                
                <!-- Notas Internas -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-sticky"></i> Notas Internas
                    </div>
                    <div class="form-group">
                        <textarea id="client-internal-notes" placeholder="Notas visibles solo para el equipo admin..." rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('client')">Cancelar</button>
                <button class="btn-primary" onclick="saveClient()">Guardar Cliente</button>
            </div>
        </div>
    </div>

    <!-- Modal Usuario -->
    <div class="modal-overlay" id="modal-user">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="bi bi-person"></i> <span id="modal-user-title">Nuevo Usuario</span></h3>
                <button class="modal-close" onclick="closeModal('user')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="user-id">
                <div class="form-group">
                    <label>Usuario *</label>
                    <input type="text" id="user-username" placeholder="nombre.usuario">
                </div>
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="user-fullname" placeholder="Juan P칠rez">
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="user-email" placeholder="juan@email.com">
                </div>
                <div class="form-group">
                    <label>Contrase침a <span id="password-hint">(requerida)</span></label>
                    <input type="password" id="user-password" placeholder="뮉뮉뮉뮉뮉뮉뮉">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('user')">Cancelar</button>
                <button class="btn-primary" onclick="saveUser()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Actualizaci칩n -->
    <div class="modal-overlay" id="modal-update">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="bi bi-megaphone"></i> <span id="modal-update-title">Nueva Actualizaci칩n</span></h3>
                <button class="modal-close" onclick="closeModal('update')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="update-id">
                <div class="form-group">
                    <label>M칩dulo *</label>
                    <select id="update-module">
                        <option value="">Seleccione un m칩dulo</option>
                        <option value="Indicadores">Indicadores</option>
                        <option value="Encuestas">Encuestas</option>
                        <option value="PQR">PQR</option>
                        <option value="Formaci칩n">Formaci칩n</option>
                        <option value="Tareas">Tareas</option>
                        <option value="Procedimientos">Procedimientos</option>
                        <option value="Configuraci칩n">Configuraci칩n</option>
                        <option value="Seguridad">Seguridad</option>
                        <option value="General">General</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Funcionalidad *</label>
                    <input type="text" id="update-feature" placeholder="Ej: Dashboard de indicadores">
                </div>
                <div class="form-group">
                    <label>Versi칩n *</label>
                    <input type="text" id="update-version" placeholder="Ej: 1.0.0">
                </div>
                <div class="form-group">
                    <label>Detalle *</label>
                    <div class="quill-container">
                        <div id="update-detail-editor"></div>
                    </div>
                    <input type="hidden" id="update-detail">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="update-published" checked> Publicar inmediatamente
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('update')">Cancelar</button>
                <button class="btn-primary" onclick="saveUpdate()">Guardar</button>
            </div>
        </div>
    </div>
            <!-- Modal Pa칤s -->
    <div class="modal-overlay" id="modal-country">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="bi bi-globe-americas"></i> <span id="modal-country-title">Nuevo Pa칤s</span></h3>
                <button class="modal-close" onclick="closeModal('country')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="country-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>C칩digo ISO *</label>
                        <input type="text" id="country-code" placeholder="CO" maxlength="2" style="text-transform: uppercase;">
                        <small>C칩digo de 2 letras (ISO 3166-1 alfa-2)</small>
                    </div>
                    <div class="form-group">
                        <label>Emoji Bandera</label>
                        <input type="text" id="country-flag" placeholder="游뻟릖">
                    </div>
                </div>
                <div class="form-group">
                    <label>Nombre del Pa칤s *</label>
                    <input type="text" id="country-name" placeholder="Colombia">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Precio Anual USD *</label>
                        <input type="number" id="country-price" placeholder="230" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Banda de Precio</label>
                        <select id="country-band">
                            <option value="indigo">Indigo ($99)</option>
                            <option value="naranja">Naranja ($149)</option>
                            <option value="verde" selected>Verde ($230)</option>
                            <option value="azul">Azul ($299)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="country-active" checked> Pa칤s activo (disponible para venta)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('country')">Cancelar</button>
                <button class="btn-primary" onclick="saveCountry()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Tipo de Cliente -->
    <div class="modal-overlay" id="modal-client-type">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="bi bi-tags"></i> <span id="modal-client-type-title">Nuevo Tipo de Cliente</span></h3>
                <button class="modal-close" onclick="closeModal('client-type')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="client-type-id-field">
                <div class="form-row">
                    <div class="form-group">
                        <label>C칩digo *</label>
                        <input type="text" id="client-type-code" placeholder="EDU" style="text-transform: uppercase;">
                        <small>C칩digo corto 칰nico (ej: EDU, HEALTH, GOV)</small>
                    </div>
                    <div class="form-group">
                        <label>Icono (emoji)</label>
                        <input type="text" id="client-type-icon" placeholder="游꿉">
                    </div>
                </div>
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="client-type-name" placeholder="Educaci칩n">
                </div>
                <div class="form-group">
                    <label>Descripci칩n</label>
                    <textarea id="client-type-description" placeholder="Universidades, colegios, institutos..." rows="2"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Orden de visualizaci칩n</label>
                        <input type="number" id="client-type-order" placeholder="0" min="0">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0;">
                            <input type="checkbox" id="client-type-active" checked> Activo
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('client-type')">Cancelar</button>
                <button class="btn-primary" onclick="saveClientType()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Alianza -->
    <div class="modal-overlay" id="modal-alliance">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3><i class="bi bi-handshake"></i> <span id="modal-alliance-title">Nueva Alianza</span></h3>
                <button class="modal-close" onclick="closeModal('alliance')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="alliance-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>C칩digo *</label>
                        <input type="text" id="alliance-code" placeholder="CCB" style="text-transform: uppercase;">
                        <small>C칩digo 칰nico corto</small>
                    </div>
                    <div class="form-group">
                        <label>Porcentaje de Descuento *</label>
                        <input type="number" id="alliance-discount" placeholder="15" min="0" max="100" step="0.01">
                        <small>% de descuento sobre precio base</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Nombre de la Alianza *</label>
                    <input type="text" id="alliance-name" placeholder="C치mara de Comercio de Bogot치">
                </div>
                
                <div class="form-group">
                    <label>Descripci칩n</label>
                    <textarea id="alliance-description" placeholder="Descripci칩n de la alianza y beneficios..." rows="2"></textarea>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-person-lines-fill"></i> Contacto
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre del Contacto</label>
                            <input type="text" id="alliance-contact-name" placeholder="Juan P칠rez">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="alliance-contact-email" placeholder="contacto@camara.org">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tel칠fono</label>
                        <input type="tel" id="alliance-contact-phone" placeholder="+57 1 234 5678">
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-calendar-range"></i> Vigencia
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>V치lida Desde</label>
                            <input type="date" id="alliance-valid-from">
                        </div>
                        <div class="form-group">
                            <label>V치lida Hasta</label>
                            <input type="date" id="alliance-valid-until">
                            <small>Dejar vac칤o para vigencia indefinida</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>L칤mite de Clientes</label>
                        <input type="number" id="alliance-max-clients" placeholder="Ilimitado" min="1">
                        <small>Dejar vac칤o para ilimitado</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notas internas</label>
                    <textarea id="alliance-notes" placeholder="Notas sobre el acuerdo..." rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="alliance-active" checked> Alianza activa
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('alliance')">Cancelar</button>
                <button class="btn-primary" onclick="saveAlliance()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Canal de Venta -->
    <div class="modal-overlay" id="modal-sales-channel">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3><i class="bi bi-diagram-3"></i> <span id="modal-sales-channel-title">Nuevo Canal de Venta</span></h3>
                <button class="modal-close" onclick="closeModal('sales-channel')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="sales-channel-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>C칩digo *</label>
                        <input type="text" id="sales-channel-code" placeholder="PARTNER_001" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Canal *</label>
                        <select id="sales-channel-type">
                            <option value="">Seleccione...</option>
                            <option value="direct">Ventas Directas</option>
                            <option value="partner">Partner</option>
                            <option value="reseller">Reseller</option>
                            <option value="affiliate">Afiliado</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Nombre del Canal *</label>
                    <input type="text" id="sales-channel-name" placeholder="Partner Tecnolog칤a ABC">
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-percent"></i> Comisiones
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Porcentaje de Comisi칩n *</label>
                            <input type="number" id="sales-channel-commission" placeholder="15" min="0" max="100" step="0.01">
                            <small>% sobre el precio final pagado</small>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem;">
                                <input type="checkbox" id="sales-channel-commission-renewal" checked> Comisi칩n en renovaciones
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-person-lines-fill"></i> Contacto
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre del Contacto</label>
                            <input type="text" id="sales-channel-contact-name" placeholder="Mar칤a Garc칤a">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="sales-channel-contact-email" placeholder="maria@partner.com">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tel칠fono</label>
                        <input type="tel" id="sales-channel-contact-phone" placeholder="+57 300 123 4567">
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-bank"></i> Datos de Pago
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>M칠todo de Pago</label>
                            <select id="sales-channel-payment-method">
                                <option value="">Seleccione...</option>
                                <option value="transfer">Transferencia Bancaria</option>
                                <option value="paypal">PayPal</option>
                                <option value="other">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>NIT / C칠dula</label>
                            <input type="text" id="sales-channel-tax-id" placeholder="123.456.789-0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Banco</label>
                            <input type="text" id="sales-channel-bank-name" placeholder="Bancolombia">
                        </div>
                        <div class="form-group">
                            <label>Tipo de Cuenta</label>
                            <select id="sales-channel-bank-type">
                                <option value="">Seleccione...</option>
                                <option value="ahorros">Ahorros</option>
                                <option value="corriente">Corriente</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>N칰mero de Cuenta</label>
                            <input type="text" id="sales-channel-bank-account" placeholder="123-456789-00">
                        </div>
                        <div class="form-group">
                            <label>Titular de la Cuenta</label>
                            <input type="text" id="sales-channel-bank-holder" placeholder="Nombre del titular">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="sales-channel-notes" placeholder="Notas sobre el canal..." rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sales-channel-active" checked> Canal activo
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('sales-channel')">Cancelar</button>
                <button class="btn-primary" onclick="saveSalesChannel()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Renovaci칩n / Registrar Pago -->
    <div class="modal-overlay" id="modal-renewal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="bi bi-credit-card"></i> <span id="modal-renewal-title">Registrar Pago</span></h3>
                <button class="modal-close" onclick="closeModal('renewal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="renewal-id">
                
                <div class="form-group">
                    <label>Cliente *</label>
                    <select id="renewal-client-id" onchange="loadClientPriceForRenewal()">
                        <option value="">Seleccione un cliente...</option>
                    </select>
                </div>
                
                <div id="renewal-client-info" style="display: none; background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                        <div><strong>Pa칤s:</strong> <span id="renewal-client-country"></span></div>
                        <div><strong>Precio base:</strong> <span id="renewal-client-base-price"></span></div>
                        <div><strong>Alianza:</strong> <span id="renewal-client-alliance"></span></div>
                        <div><strong>Precio final:</strong> <span id="renewal-client-final-price" style="color: var(--primary-color); font-weight: bold;"></span></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Per칤odo Inicio *</label>
                        <input type="date" id="renewal-period-start">
                    </div>
                    <div class="form-group">
                        <label>Per칤odo Fin *</label>
                        <input type="date" id="renewal-period-end">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Monto Final USD *</label>
                        <input type="number" id="renewal-amount" placeholder="230.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>M칠todo de Pago *</label>
                        <select id="renewal-payment-method">
                            <option value="">Seleccione...</option>
                            <option value="stripe">Stripe</option>
                            <option value="paypal">PayPal</option>
                            <option value="transfer">Transferencia Bancaria</option>
                            <option value="cash">Efectivo</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado del Pago *</label>
                        <select id="renewal-payment-status">
                            <option value="pending">Pendiente</option>
                            <option value="paid">Pagado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Pago</label>
                        <input type="date" id="renewal-payment-date">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Referencia de Pago</label>
                    <input type="text" id="renewal-payment-reference" placeholder="ID de transacci칩n o comprobante">
                </div>
                
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="renewal-notes" placeholder="Notas adicionales..." rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('renewal')">Cancelar</button>
                <button class="btn-primary" onclick="saveRenewal()">Registrar Pago</button>
            </div>
        </div>
    </div>

    <!-- Modal Ejecutar Migraciones -->
    <div class="modal-overlay" id="modal-migration">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="bi bi-database-gear"></i> Ejecutar Migraciones</h3>
                <button class="modal-close" onclick="closeModal('migration')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Importante:</strong> Las migraciones se ejecutar치n en todos los clientes que tengan versiones pendientes.
                </div>
                
                <div class="form-group">
                    <label>Seleccionar Clientes</label>
                    <select id="migration-target" class="filter-select" style="width: 100%; padding: 0.6rem;">
                        <option value="all">Todos los clientes con pendientes</option>
                        <option value="single">Un cliente espec칤fico</option>
                    </select>
                </div>
                
                <div class="form-group" id="single-client-select" style="display: none;">
                    <label>Cliente</label>
                    <select id="migration-client-id" class="filter-select" style="width: 100%; padding: 0.6rem;">
                    </select>
                </div>
                
                <div id="migration-results" style="display: none; margin-top: 1rem;">
                    <h4 style="margin-bottom: 0.5rem;">Resultados:</h4>
                    <pre id="migration-output" style="background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 6px; max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('migration')">Cerrar</button>
                <button class="btn-primary" id="btn-run-migration" onclick="runMigrations()">
                    <i class="bi bi-play-fill"></i> Ejecutar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Ficha Cliente -->
    <div class="modal-overlay" id="modal-view-client">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3><i class="bi bi-building"></i> <span id="view-client-name-title">Ficha del Cliente</span></h3>
                <button class="modal-close" onclick="closeModal('view-client')">&times;</button>
            </div>
            <div class="modal-body" id="view-client-content">
                <!-- Se llena din치micamente -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('view-client')">Cerrar</button>
                <button class="btn-primary" onclick="editClientFromView()">
                    <i class="bi bi-pencil"></i> Editar
                </button>
            </div>
        </div>
    </div>
            <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    <script>
        // ============================================
        // VERIFICAR SESI칍N
        // ============================================
        const currentUser = JSON.parse(sessionStorage.getItem('user'));
        if (!currentUser) {
            window.location.href = '../login.html';
        }
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let allRequests = [];
        let allClients = [];
        let allUpdates = [];
        let allCountries = [];
        let allClientTypes = [];
        let allAlliances = [];
        let allSalesChannels = [];
        let allRenewals = [];
        let allCommissions = [];
        let currentRequestId = null;
        let currentConfig = null;
        let quillEditor = null;
        let currentViewClientId = null;
        
        // Versi칩n actual del esquema - INCREMENTAR con cada nueva migraci칩n
        const CURRENT_SCHEMA_VERSION = 6;
        
        const MIGRATION_FILES = {
            2: 'https://cdn.jsdelivr.net/gh/adminschoolnext/gestionarte-web@main/migrations/001_add_get_public_tables.sql',
            3: 'https://cdn.jsdelivr.net/gh/adminschoolnext/gestionarte-web@main/migrations/002_add_notification_sender_name.sql',
            4: 'https://cdn.jsdelivr.net/gh/adminschoolnext/gestionarte-web@main/migrations/003_add_oauth_support_users.sql',
            5: 'https://cdn.jsdelivr.net/gh/adminschoolnext/gestionarte-web@main/migrations/004_add_oauth_support_system_config.sql',
            6: 'https://cdn.jsdelivr.net/gh/adminschoolnext/gestionarte-web@main/migrations/005_add_form_field_conditional_logic.sql',
        };
        
        // ============================================
        // INICIALIZACI칍N
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('user-name').textContent = currentUser.full_name;
            document.getElementById('dashboard-date').textContent = new Date().toLocaleDateString('es-CO', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            // Aplicar configuraci칩n del sitio
            if (typeof applySiteConfig === 'function') {
                const config = await applySiteConfig();
                if (config.site_name) {
                    document.getElementById('site-name').textContent = config.site_name;
                    document.getElementById('footer-name').textContent = config.site_name;
                }
            }
            
            // Inicializar Quill Editor
            quillEditor = new Quill('#update-detail-editor', {
                theme: 'snow',
                placeholder: 'Descripci칩n detallada de la actualizaci칩n...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link'],
                        ['clean']
                    ]
                }
            });

            // Event listener para selector de migraciones
            document.getElementById('migration-target')?.addEventListener('change', function() {
                const singleClientDiv = document.getElementById('single-client-select');
                singleClientDiv.style.display = this.value === 'single' ? 'block' : 'none';
            });
            
            // Event listeners para navegaci칩n
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchSection(item.dataset.section));
            });
            
            // Event listeners para tabs de cat치logos
            document.querySelectorAll('.catalog-tab').forEach(tab => {
                tab.addEventListener('click', () => switchCatalog(tab.dataset.catalog));
            });
            
            // Event listeners para filtros
            document.getElementById('filter-status')?.addEventListener('change', filterRequests);
            document.getElementById('filter-type')?.addEventListener('change', filterRequests);
            document.getElementById('filter-module')?.addEventListener('change', filterUpdates);
            document.getElementById('filter-published')?.addEventListener('change', filterUpdates);
            document.getElementById('filter-migration-status')?.addEventListener('change', () => renderMigrationStatus(allClients));
            
            // Filtros de clientes
            document.getElementById('filter-client-country')?.addEventListener('change', filterClients);
            document.getElementById('filter-client-type')?.addEventListener('change', filterClients);
            document.getElementById('filter-client-channel')?.addEventListener('change', filterClients);
            document.getElementById('filter-client-status')?.addEventListener('change', filterClients);
            document.getElementById('filter-client-search')?.addEventListener('input', filterClients);
            
            // Filtros de renovaciones
            document.getElementById('filter-renewal-year')?.addEventListener('change', filterRenewals);
            document.getElementById('filter-renewal-month')?.addEventListener('change', filterRenewals);
            document.getElementById('filter-renewal-status')?.addEventListener('change', filterRenewals);
            
            // Filtros de comisiones
            document.getElementById('filter-commission-year')?.addEventListener('change', filterCommissions);
            document.getElementById('filter-commission-month')?.addEventListener('change', filterCommissions);
            document.getElementById('filter-commission-status')?.addEventListener('change', filterCommissions);
            document.getElementById('filter-commission-channel')?.addEventListener('change', filterCommissions);
            
            // Checkbox seleccionar todas las comisiones
            document.getElementById('select-all-commissions')?.addEventListener('change', function() {
                document.querySelectorAll('.commission-checkbox').forEach(cb => cb.checked = this.checked);
            });
            
            // Cargar datos iniciales
            await loadCatalogs();
            await loadClients();
            await loadRenewals();
            await loadCommissions();
            loadRequests();
            loadUsers();
            loadUpdates();
            loadConfig();
            loadDashboard();
        });
        
        // ============================================
        // NAVEGACI칍N
        // ============================================
        function switchSection(section) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`)?.classList.add('active');
            
            document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${section}`).style.display = 'block';
            
            // Cargar datos espec칤ficos de cada secci칩n
            if (section === 'migraciones') {
                loadMigrationStatus();
            } else if (section === 'dashboard') {
                loadDashboard();
            }
        }
        
        function switchCatalog(catalog) {
            document.querySelectorAll('.catalog-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-catalog="${catalog}"]`)?.classList.add('active');
            
            document.querySelectorAll('.catalog-content').forEach(c => c.style.display = 'none');
            document.getElementById(`catalog-${catalog}`).style.display = 'block';
        }
        
        // ============================================
        // UTILIDADES
        // ============================================
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric'
            });
        }
        
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-CO', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatCurrency(amount) {
            return '$' + parseFloat(amount || 0).toFixed(2);
        }
        
        function getStatusClass(status) {
            const classes = {
                'pendiente': 'pending',
                'en_proceso': 'progress',
                'resuelto': 'resolved',
                'cerrado': 'closed',
                'pending': 'pending',
                'active': 'active',
                'grace_period': 'grace',
                'suspended': 'suspended',
                'cancelled': 'closed',
                'paid': 'success',
                'overdue': 'danger',
                'calculated': 'pending',
                'approved': 'progress',
            };
            return classes[status] || 'pending';
        }
        
        function getStatusLabel(status) {
            const labels = {
                'pendiente': 'Pendiente',
                'en_proceso': 'En Proceso',
                'resuelto': 'Resuelto',
                'cerrado': 'Cerrado',
                'pending': 'Pendiente',
                'active': 'Activo',
                'grace_period': 'En Gracia',
                'suspended': 'Suspendido',
                'cancelled': 'Cancelado',
                'paid': 'Pagado',
                'overdue': 'Vencido',
                'calculated': 'Calculada',
                'approved': 'Aprobada',
            };
            return labels[status] || status;
        }
        
        function getChannelTypeLabel(type) {
            const labels = {
                'direct': 'Ventas Directas',
                'partner': 'Partner',
                'reseller': 'Reseller',
                'affiliate': 'Afiliado'
            };
            return labels[type] || type;
        }
        
        function getDaysUntil(dateStr) {
            if (!dateStr) return null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(dateStr);
            target.setHours(0, 0, 0, 0);
            const diffTime = target - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-size: 0.9rem;
                z-index: 9999;
                animation: fadeIn 0.3s ease;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
            `;
            toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'}"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 4000);
        }
        
        function generateApiKey() {
            const key = 'key-' + Math.random().toString(36).substring(2, 10) + '-' + Date.now().toString(36);
            document.getElementById('client-api-key').value = key;
        }
        
        function logout() {
            sessionStorage.removeItem('user');
            window.location.href = '../login.html';
        }
        
        // ============================================
        // MODALES - ABRIR/CERRAR
        // ============================================
        function openModal(type, id = null) {
            // Limpiar formularios seg칰n el tipo
            if (type === 'client' && !id) {
                clearClientForm();
            } else if (type === 'user' && !id) {
                clearUserForm();
            } else if (type === 'update' && !id) {
                clearUpdateForm();
            } else if (type === 'country' && !id) {
                clearCountryForm();
            } else if (type === 'client-type' && !id) {
                clearClientTypeForm();
            } else if (type === 'alliance' && !id) {
                clearAllianceForm();
            } else if (type === 'sales-channel' && !id) {
                clearSalesChannelForm();
            } else if (type === 'renewal' && !id) {
                clearRenewalForm();
            }
            
            document.getElementById(`modal-${type}`).classList.add('show');
        }
        
        function closeModal(type) {
            document.getElementById(`modal-${type}`).classList.remove('show');
        }
        
        // ============================================
        // CARGAR CAT츼LOGOS
        // ============================================
        async function loadCatalogs() {
            await Promise.all([
                loadCountries(),
                loadClientTypes(),
                loadAlliances(),
                loadSalesChannels()
            ]);
            populateFilterSelects();
        }
        
        async function loadCountries() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/countries?select=*&order=name.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                allCountries = await response.json();
                renderCountries();
            } catch (error) {
                console.error('Error cargando pa칤ses:', error);
                allCountries = [];
            }
        }
        
        function renderCountries() {
            const tbody = document.getElementById('table-paises');
            if (!tbody) return;
            
            if (allCountries.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><i class="bi bi-globe"></i><p>No hay pa칤ses registrados</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = allCountries.map(c => `
                <tr>
                    <td>${c.flag_emoji || ''} ${c.name}</td>
                    <td><code>${c.code}</code></td>
                    <td><strong>${formatCurrency(c.annual_price_usd)}</strong></td>
                    <td><span class="badge badge-${c.price_band || 'verde'}">${c.price_band || 'verde'}</span></td>
                    <td><span class="badge ${c.is_active ? 'badge-success' : 'badge-closed'}">${c.is_active ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <button class="btn-action" onclick="editCountry(${c.id})" title="Editar"><i class="bi bi-pencil"></i></button>
                        <button class="btn-action" onclick="toggleCountryStatus(${c.id}, ${c.is_active})" title="${c.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${c.is_active ? 'pause' : 'play'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function loadClientTypes() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/client_types?select=*&order=display_order.asc,name.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                allClientTypes = await response.json();
                renderClientTypes();
            } catch (error) {
                console.error('Error cargando tipos de cliente:', error);
                allClientTypes = [];
            }
        }
        
        function renderClientTypes() {
            const tbody = document.getElementById('table-tipos');
            if (!tbody) return;
            
            if (allClientTypes.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><i class="bi bi-tags"></i><p>No hay tipos registrados</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = allClientTypes.map(t => `
                <tr>
                    <td style="font-size: 1.5rem;">${t.icon || '游늶'}</td>
                    <td><code>${t.code}</code></td>
                    <td><strong>${t.name}</strong></td>
                    <td>${t.description || '-'}</td>
                    <td><span class="badge ${t.is_active ? 'badge-success' : 'badge-closed'}">${t.is_active ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <button class="btn-action" onclick="editClientType(${t.id})" title="Editar"><i class="bi bi-pencil"></i></button>
                        <button class="btn-action" onclick="toggleClientTypeStatus(${t.id}, ${t.is_active})" title="${t.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${t.is_active ? 'pause' : 'play'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function loadAlliances() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/alliances?select=*&order=name.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                allAlliances = await response.json();
                renderAlliances();
            } catch (error) {
                console.error('Error cargando alianzas:', error);
                allAlliances = [];
            }
        }
        
        function renderAlliances() {
            const tbody = document.getElementById('table-alianzas');
            if (!tbody) return;
            
            if (allAlliances.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="bi bi-handshake"></i><p>No hay alianzas registradas</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = allAlliances.map(a => {
                const clientCount = allClients.filter(c => c.alliance_id === a.id).length;
                const vigencia = a.valid_until ? `${formatDate(a.valid_from)} - ${formatDate(a.valid_until)}` : (a.valid_from ? `Desde ${formatDate(a.valid_from)}` : 'Indefinida');
                
                return `
                <tr>
                    <td><code>${a.code}</code></td>
                    <td><strong>${a.name}</strong></td>
                    <td><span class="badge badge-verde">${a.discount_percentage}%</span></td>
                    <td>${vigencia}</td>
                    <td>${clientCount} ${a.max_clients ? `/ ${a.max_clients}` : ''}</td>
                    <td><span class="badge ${a.is_active ? 'badge-success' : 'badge-closed'}">${a.is_active ? 'Activa' : 'Inactiva'}</span></td>
                    <td>
                        <button class="btn-action" onclick="editAlliance(${a.id})" title="Editar"><i class="bi bi-pencil"></i></button>
                        <button class="btn-action" onclick="toggleAllianceStatus(${a.id}, ${a.is_active})" title="${a.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${a.is_active ? 'pause' : 'play'}"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }
        
        async function loadSalesChannels() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/sales_channels?select=*&order=name.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                allSalesChannels = await response.json();
                renderSalesChannels();
            } catch (error) {
                console.error('Error cargando canales:', error);
                allSalesChannels = [];
            }
        }
        
        function renderSalesChannels() {
            const tbody = document.getElementById('table-canales');
            if (!tbody) return;
            
            if (allSalesChannels.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="bi bi-diagram-3"></i><p>No hay canales registrados</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = allSalesChannels.map(ch => `
                <tr>
                    <td><code>${ch.code}</code></td>
                    <td><strong>${ch.name}</strong></td>
                    <td><span class="badge badge-${ch.channel_type === 'direct' ? 'azul' : 'verde'}">${getChannelTypeLabel(ch.channel_type)}</span></td>
                    <td>${ch.commission_percentage}%</td>
                    <td>${ch.commission_on_renewal ? '<i class="bi bi-check-circle text-success"></i> S칤' : '<i class="bi bi-x-circle text-muted"></i> No'}</td>
                    <td><span class="badge ${ch.is_active ? 'badge-success' : 'badge-closed'}">${ch.is_active ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <button class="btn-action" onclick="editSalesChannel(${ch.id})" title="Editar"><i class="bi bi-pencil"></i></button>
                        <button class="btn-action" onclick="toggleSalesChannelStatus(${ch.id}, ${ch.is_active})" title="${ch.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${ch.is_active ? 'pause' : 'play'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function populateFilterSelects() {
            // Pa칤ses en filtros y selects
            const countryOptions = allCountries.filter(c => c.is_active).map(c => `<option value="${c.id}">${c.flag_emoji || ''} ${c.name}</option>`).join('');
            
            document.getElementById('filter-client-country').innerHTML = '<option value="">Todos los pa칤ses</option>' + countryOptions;
            document.getElementById('client-country-id').innerHTML = '<option value="">Seleccione un pa칤s...</option>' + countryOptions;
            
            // Tipos de cliente
            const typeOptions = allClientTypes.filter(t => t.is_active).map(t => `<option value="${t.id}">${t.icon || ''} ${t.name}</option>`).join('');
            
            document.getElementById('filter-client-type').innerHTML = '<option value="">Todos los tipos</option>' + typeOptions;
            document.getElementById('client-type-id').innerHTML = '<option value="">Seleccione...</option>' + typeOptions;
            
            // Canales de venta
            const channelOptions = allSalesChannels.filter(ch => ch.is_active).map(ch => `<option value="${ch.id}">${ch.name}</option>`).join('');
            
            document.getElementById('filter-client-channel').innerHTML = '<option value="">Todos los canales</option>' + channelOptions;
            document.getElementById('client-sales-channel-id').innerHTML = '<option value="">Seleccione...</option>' + channelOptions;
            document.getElementById('filter-commission-channel').innerHTML = '<option value="">Todos los canales</option>' + channelOptions;
            
            // Alianzas
            const allianceOptions = allAlliances.filter(a => a.is_active).map(a => `<option value="${a.id}">${a.name} (${a.discount_percentage}%)</option>`).join('');
            
            document.getElementById('client-alliance-id').innerHTML = '<option value="">Sin alianza</option>' + allianceOptions;
        }
        // ============================================
        // CLEAR FORMS
        // ============================================
        function clearClientForm() {
            document.getElementById('modal-client-title').textContent = 'Nuevo Cliente';
            document.getElementById('client-id').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('client-organization-name').value = '';
            document.getElementById('client-tax-id').value = '';
            document.getElementById('client-employee-range').value = '';
            document.getElementById('client-country-id').value = '';
            document.getElementById('client-type-id').value = '';
            document.getElementById('client-city').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-address').value = '';
            document.getElementById('client-admin-name').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-billing-email').value = '';
            document.getElementById('client-sales-channel-id').value = '';
            document.getElementById('client-alliance-id').value = '';
            document.getElementById('client-api-key').value = '';
            document.getElementById('client-deployment-url').value = '';
            document.getElementById('client-supabase-url').value = '';
            document.getElementById('client-supabase-anon-key').value = '';
            document.getElementById('client-supabase-service-key').value = '';
            document.getElementById('client-postgres-password').value = '';
            document.getElementById('client-project-email').value = '';
            document.getElementById('client-project-email-password').value = '';
            document.getElementById('client-internal-notes').value = '';
            updatePriceCalculation();
        }
        
        function clearUserForm() {
            document.getElementById('modal-user-title').textContent = 'Nuevo Usuario';
            document.getElementById('user-id').value = '';
            document.getElementById('user-username').value = '';
            document.getElementById('user-fullname').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-password').value = '';
            document.getElementById('password-hint').textContent = '(requerida)';
        }
        
        function clearUpdateForm() {
            document.getElementById('modal-update-title').textContent = 'Nueva Actualizaci칩n';
            document.getElementById('update-id').value = '';
            document.getElementById('update-module').value = '';
            document.getElementById('update-feature').value = '';
            document.getElementById('update-version').value = '';
            document.getElementById('update-published').checked = true;
            if (quillEditor) quillEditor.setContents([]);
        }
        
        function clearCountryForm() {
            document.getElementById('modal-country-title').textContent = 'Nuevo Pa칤s';
            document.getElementById('country-id').value = '';
            document.getElementById('country-code').value = '';
            document.getElementById('country-flag').value = '';
            document.getElementById('country-name').value = '';
            document.getElementById('country-price').value = '';
            document.getElementById('country-band').value = 'verde';
            document.getElementById('country-active').checked = true;
        }
        
        function clearClientTypeForm() {
            document.getElementById('modal-client-type-title').textContent = 'Nuevo Tipo de Cliente';
            document.getElementById('client-type-id-field').value = '';
            document.getElementById('client-type-code').value = '';
            document.getElementById('client-type-icon').value = '';
            document.getElementById('client-type-name').value = '';
            document.getElementById('client-type-description').value = '';
            document.getElementById('client-type-order').value = '0';
            document.getElementById('client-type-active').checked = true;
        }
        
        function clearAllianceForm() {
            document.getElementById('modal-alliance-title').textContent = 'Nueva Alianza';
            document.getElementById('alliance-id').value = '';
            document.getElementById('alliance-code').value = '';
            document.getElementById('alliance-discount').value = '';
            document.getElementById('alliance-name').value = '';
            document.getElementById('alliance-description').value = '';
            document.getElementById('alliance-contact-name').value = '';
            document.getElementById('alliance-contact-email').value = '';
            document.getElementById('alliance-contact-phone').value = '';
            document.getElementById('alliance-valid-from').value = '';
            document.getElementById('alliance-valid-until').value = '';
            document.getElementById('alliance-max-clients').value = '';
            document.getElementById('alliance-notes').value = '';
            document.getElementById('alliance-active').checked = true;
        }
        
        function clearSalesChannelForm() {
            document.getElementById('modal-sales-channel-title').textContent = 'Nuevo Canal de Venta';
            document.getElementById('sales-channel-id').value = '';
            document.getElementById('sales-channel-code').value = '';
            document.getElementById('sales-channel-type').value = '';
            document.getElementById('sales-channel-name').value = '';
            document.getElementById('sales-channel-commission').value = '';
            document.getElementById('sales-channel-commission-renewal').checked = true;
            document.getElementById('sales-channel-contact-name').value = '';
            document.getElementById('sales-channel-contact-email').value = '';
            document.getElementById('sales-channel-contact-phone').value = '';
            document.getElementById('sales-channel-payment-method').value = '';
            document.getElementById('sales-channel-tax-id').value = '';
            document.getElementById('sales-channel-bank-name').value = '';
            document.getElementById('sales-channel-bank-type').value = '';
            document.getElementById('sales-channel-bank-account').value = '';
            document.getElementById('sales-channel-bank-holder').value = '';
            document.getElementById('sales-channel-notes').value = '';
            document.getElementById('sales-channel-active').checked = true;
        }
        
        function clearRenewalForm() {
            document.getElementById('modal-renewal-title').textContent = 'Registrar Pago';
            document.getElementById('renewal-id').value = '';
            document.getElementById('renewal-client-id').value = '';
            document.getElementById('renewal-period-start').value = '';
            document.getElementById('renewal-period-end').value = '';
            document.getElementById('renewal-amount').value = '';
            document.getElementById('renewal-payment-method').value = '';
            document.getElementById('renewal-payment-status').value = 'pending';
            document.getElementById('renewal-payment-date').value = '';
            document.getElementById('renewal-payment-reference').value = '';
            document.getElementById('renewal-notes').value = '';
            document.getElementById('renewal-client-info').style.display = 'none';
            
            // Poblar selector de clientes
            const clientSelect = document.getElementById('renewal-client-id');
            clientSelect.innerHTML = '<option value="">Seleccione un cliente...</option>' + 
                allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        // ============================================
        // CRUD PA칈SES
        // ============================================
        function editCountry(id) {
            const country = allCountries.find(c => c.id === id);
            if (!country) return;
            
            document.getElementById('modal-country-title').textContent = 'Editar Pa칤s';
            document.getElementById('country-id').value = id;
            document.getElementById('country-code').value = country.code;
            document.getElementById('country-flag').value = country.flag_emoji || '';
            document.getElementById('country-name').value = country.name;
            document.getElementById('country-price').value = country.annual_price_usd;
            document.getElementById('country-band').value = country.price_band || 'verde';
            document.getElementById('country-active').checked = country.is_active;
            
            openModal('country');
        }
        
        async function saveCountry() {
            const id = document.getElementById('country-id').value;
            const data = {
                code: document.getElementById('country-code').value.toUpperCase(),
                name: document.getElementById('country-name').value,
                flag_emoji: document.getElementById('country-flag').value || null,
                annual_price_usd: parseFloat(document.getElementById('country-price').value) || 0,
                price_band: document.getElementById('country-band').value,
                is_active: document.getElementById('country-active').checked,
                updated_at: new Date().toISOString()
            };
            
            if (!data.code || !data.name || !data.annual_price_usd) {
                showToast('C칩digo, nombre y precio son requeridos', 'error');
                return;
            }
            
            try {
                const url = id 
                    ? `${SUPABASE_CONFIG.url}/rest/v1/countries?id=eq.${id}`
                    : `${SUPABASE_CONFIG.url}/rest/v1/countries`;
                
                await fetch(url, {
                    method: id ? 'PATCH' : 'POST',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                closeModal('country');
                await loadCountries();
                populateFilterSelects();
                showToast('Pa칤s guardado correctamente', 'success');
            } catch (error) {
                console.error('Error guardando pa칤s:', error);
                showToast('Error al guardar el pa칤s', 'error');
            }
        }
        
        async function toggleCountryStatus(id, currentStatus) {
            try {
                await fetch(`${SUPABASE_CONFIG.url}/rest/v1/countries?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: !currentStatus })
                });
                await loadCountries();
                populateFilterSelects();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // ============================================
        // CRUD TIPOS DE CLIENTE
        // ============================================
        function editClientType(id) {
            const type = allClientTypes.find(t => t.id === id);
            if (!type) return;
            
            document.getElementById('modal-client-type-title').textContent = 'Editar Tipo de Cliente';
            document.getElementById('client-type-id-field').value = id;
            document.getElementById('client-type-code').value = type.code;
            document.getElementById('client-type-icon').value = type.icon || '';
            document.getElementById('client-type-name').value = type.name;
            document.getElementById('client-type-description').value = type.description || '';
            document.getElementById('client-type-order').value = type.display_order || 0;
            document.getElementById('client-type-active').checked = type.is_active;
            
            openModal('client-type');
        }
        
        async function saveClientType() {
            const id = document.getElementById('client-type-id-field').value;
            const data = {
                code: document.getElementById('client-type-code').value.toUpperCase(),
                name: document.getElementById('client-type-name').value,
                icon: document.getElementById('client-type-icon').value || null,
                description: document.getElementById('client-type-description').value || null,
                display_order: parseInt(document.getElementById('client-type-order').value) || 0,
                is_active: document.getElementById('client-type-active').checked,
                updated_at: new Date().toISOString()
            };
            
            if (!data.code || !data.name) {
                showToast('C칩digo y nombre son requeridos', 'error');
                return;
            }
            
            try {
                const url = id 
                    ? `${SUPABASE_CONFIG.url}/rest/v1/client_types?id=eq.${id}`
                    : `${SUPABASE_CONFIG.url}/rest/v1/client_types`;
                
                await fetch(url, {
                    method: id ? 'PATCH' : 'POST',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                closeModal('client-type');
                await loadClientTypes();
                populateFilterSelects();
                showToast('Tipo de cliente guardado', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al guardar', 'error');
            }
        }
        
        async function toggleClientTypeStatus(id, currentStatus) {
            try {
                await fetch(`${SUPABASE_CONFIG.url}/rest/v1/client_types?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: !currentStatus })
                });
                await loadClientTypes();
                populateFilterSelects();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // ============================================
        // CRUD ALIANZAS
        // ============================================
        function editAlliance(id) {
            const alliance = allAlliances.find(a => a.id === id);
            if (!alliance) return;
            
            document.getElementById('modal-alliance-title').textContent = 'Editar Alianza';
            document.getElementById('alliance-id').value = id;
            document.getElementById('alliance-code').value = alliance.code;
            document.getElementById('alliance-discount').value = alliance.discount_percentage;
            document.getElementById('alliance-name').value = alliance.name;
            document.getElementById('alliance-description').value = alliance.description || '';
            document.getElementById('alliance-contact-name').value = alliance.contact_name || '';
            document.getElementById('alliance-contact-email').value = alliance.contact_email || '';
            document.getElementById('alliance-contact-phone').value = alliance.contact_phone || '';
            document.getElementById('alliance-valid-from').value = alliance.valid_from || '';
            document.getElementById('alliance-valid-until').value = alliance.valid_until || '';
            document.getElementById('alliance-max-clients').value = alliance.max_clients || '';
            document.getElementById('alliance-notes').value = alliance.notes || '';
            document.getElementById('alliance-active').checked = alliance.is_active;
            
            openModal('alliance');
        }
        
        async function saveAlliance() {
            const id = document.getElementById('alliance-id').value;
            const data = {
                code: document.getElementById('alliance-code').value.toUpperCase(),
                name: document.getElementById('alliance-name').value,
                discount_percentage: parseFloat(document.getElementById('alliance-discount').value) || 0,
                description: document.getElementById('alliance-description').value || null,
                contact_name: document.getElementById('alliance-contact-name').value || null,
                contact_email: document.getElementById('alliance-contact-email').value || null,
                contact_phone: document.getElementById('alliance-contact-phone').value || null,
                valid_from: document.getElementById('alliance-valid-from').value || null,
                valid_until: document.getElementById('alliance-valid-until').value || null,
                max_clients: parseInt(document.getElementById('alliance-max-clients').value) || null,
                notes: document.getElementById('alliance-notes').value || null,
                is_active: document.getElementById('alliance-active').checked,
                updated_at: new Date().toISOString()
            };
            
            if (!data.code || !data.name) {
                showToast('C칩digo y nombre son requeridos', 'error');
                return;
            }
            
            try {
                const url = id 
                    ? `${SUPABASE_CONFIG.url}/rest/v1/alliances?id=eq.${id}`
                    : `${SUPABASE_CONFIG.url}/rest/v1/alliances`;
                
                await fetch(url, {
                    method: id ? 'PATCH' : 'POST',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                closeModal('alliance');
                await loadAlliances();
                populateFilterSelects();
                showToast('Alianza guardada correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al guardar', 'error');
            }
        }
        
        async function toggleAllianceStatus(id, currentStatus) {
            try {
                await fetch(`${SUPABASE_CONFIG.url}/rest/v1/alliances?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: !currentStatus })
                });
                await loadAlliances();
                populateFilterSelects();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // ============================================
        // CRUD CANALES DE VENTA
        // ============================================
        function editSalesChannel(id) {
            const channel = allSalesChannels.find(ch => ch.id === id);
            if (!channel) return;
            
            document.getElementById('modal-sales-channel-title').textContent = 'Editar Canal de Venta';
            document.getElementById('sales-channel-id').value = id;
            document.getElementById('sales-channel-code').value = channel.code;
            document.getElementById('sales-channel-type').value = channel.channel_type;
            document.getElementById('sales-channel-name').value = channel.name;
            document.getElementById('sales-channel-commission').value = channel.commission_percentage;
            document.getElementById('sales-channel-commission-renewal').checked = channel.commission_on_renewal;
            document.getElementById('sales-channel-contact-name').value = channel.contact_name || '';
            document.getElementById('sales-channel-contact-email').value = channel.contact_email || '';
            document.getElementById('sales-channel-contact-phone').value = channel.contact_phone || '';
            document.getElementById('sales-channel-payment-method').value = channel.payment_method || '';
            document.getElementById('sales-channel-tax-id').value = channel.tax_id || '';
            document.getElementById('sales-channel-bank-name').value = channel.bank_name || '';
            document.getElementById('sales-channel-bank-type').value = channel.bank_account_type || '';
            document.getElementById('sales-channel-bank-account').value = channel.bank_account_number || '';
            document.getElementById('sales-channel-bank-holder').value = channel.bank_account_holder || '';
            document.getElementById('sales-channel-notes').value = channel.notes || '';
            document.getElementById('sales-channel-active').checked = channel.is_active;
            
            openModal('sales-channel');
        }
        
        async function saveSalesChannel() {
            const id = document.getElementById('sales-channel-id').value;
            const data = {
                code: document.getElementById('sales-channel-code').value.toUpperCase(),
                name: document.getElementById('sales-channel-name').value,
                channel_type: document.getElementById('sales-channel-type').value,
                commission_percentage: parseFloat(document.getElementById('sales-channel-commission').value) || 0,
                commission_on_renewal: document.getElementById('sales-channel-commission-renewal').checked,
                contact_name: document.getElementById('sales-channel-contact-name').value || null,
                contact_email: document.getElementById('sales-channel-contact-email').value || null,
                contact_phone: document.getElementById('sales-channel-contact-phone').value || null,
                payment_method: document.getElementById('sales-channel-payment-method').value || null,
                tax_id: document.getElementById('sales-channel-tax-id').value || null,
                bank_name: document.getElementById('sales-channel-bank-name').value || null,
                bank_account_type: document.getElementById('sales-channel-bank-type').value || null,
                bank_account_number: document.getElementById('sales-channel-bank-account').value || null,
                bank_account_holder: document.getElementById('sales-channel-bank-holder').value || null,
                notes: document.getElementById('sales-channel-notes').value || null,
                is_active: document.getElementById('sales-channel-active').checked,
                updated_at: new Date().toISOString()
            };
            
            if (!data.code || !data.name || !data.channel_type) {
                showToast('C칩digo, nombre y tipo son requeridos', 'error');
                return;
            }
            
            try {
                const url = id 
                    ? `${SUPABASE_CONFIG.url}/rest/v1/sales_channels?id=eq.${id}`
                    : `${SUPABASE_CONFIG.url}/rest/v1/sales_channels`;
                
                await fetch(url, {
                    method: id ? 'PATCH' : 'POST',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                closeModal('sales-channel');
                await loadSalesChannels();
                populateFilterSelects();
                showToast('Canal guardado correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al guardar', 'error');
            }
        }
        
        async function toggleSalesChannelStatus(id, currentStatus) {
            try {
                await fetch(`${SUPABASE_CONFIG.url}/rest/v1/sales_channels?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: !currentStatus })
                });
                await loadSalesChannels();
                populateFilterSelects();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // ============================================
        // CLIENTES - CARGAR Y RENDERIZAR
        // ============================================
        async function loadClients() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/clients?select=*&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                allClients = await response.json();
                renderClients(allClients);
                updateClientStats();
            } catch (error) {
                console.error('Error cargando clientes:', error);
            }
        }
        
        function renderClients(clients) {
            const tbody = document.getElementById('table-clientes');
            
            if (clients.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="bi bi-building"></i><p>No hay clientes registrados</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = clients.map(c => {
                const country = allCountries.find(co => co.id === c.country_id);
                const clientType = allClientTypes.find(t => t.id === c.client_type_id);
                const channel = allSalesChannels.find(ch => ch.id === c.sales_channel_id);
                const daysUntil = getDaysUntil(c.subscription_end_date);
                
                let statusBadge = '';
                let daysIndicator = '';
                
                if (c.subscription_status === 'active') {
                    if (daysUntil !== null && daysUntil <= 30 && daysUntil > 0) {
                        statusBadge = `<span class="badge badge-grace">${daysUntil} d칤as</span>`;
                        daysIndicator = 'days-warning';
                    } else if (daysUntil !== null && daysUntil <= 0) {
                        statusBadge = `<span class="badge badge-danger">Vencido</span>`;
                        daysIndicator = 'days-danger';
                    } else {
                        statusBadge = `<span class="badge badge-active">Activo</span>`;
                    }
                } else {
                    statusBadge = `<span class="badge badge-${getStatusClass(c.subscription_status)}">${getStatusLabel(c.subscription_status)}</span>`;
                }
                
                return `
                <tr>
                    <td>
                        <strong>${c.name}</strong>
                        ${c.organization_name ? `<br><small style="color: #6c757d;">${c.organization_name}</small>` : ''}
                    </td>
                    <td>${country ? `${country.flag_emoji || ''} ${country.name}` : '-'}</td>
                    <td>${clientType ? `${clientType.icon || ''} ${clientType.name}` : '-'}</td>
                    <td>${channel ? channel.name : '-'}</td>
                    <td><strong>${formatCurrency(c.final_price_usd || c.base_price_usd)}</strong></td>
                    <td class="${daysIndicator}">${formatDate(c.subscription_end_date)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn-action" onclick="viewClient(${c.id})" title="Ver ficha"><i class="bi bi-eye"></i></button>
                        <button class="btn-action" onclick="editClient(${c.id})" title="Editar"><i class="bi bi-pencil"></i></button>
                        <button class="btn-action" onclick="openRenewalForClient(${c.id})" title="Registrar pago"><i class="bi bi-credit-card"></i></button>
                    </td>
                </tr>
            `}).join('');
        }
        
        function filterClients() {
            const countryFilter = document.getElementById('filter-client-country').value;
            const typeFilter = document.getElementById('filter-client-type').value;
            const channelFilter = document.getElementById('filter-client-channel').value;
            const statusFilter = document.getElementById('filter-client-status').value;
            const searchFilter = document.getElementById('filter-client-search').value.toLowerCase();
            
            let filtered = allClients;
            
            if (countryFilter) filtered = filtered.filter(c => c.country_id == countryFilter);
            if (typeFilter) filtered = filtered.filter(c => c.client_type_id == typeFilter);
            if (channelFilter) filtered = filtered.filter(c => c.sales_channel_id == channelFilter);
            if (statusFilter) filtered = filtered.filter(c => c.subscription_status === statusFilter);
            if (searchFilter) {
                filtered = filtered.filter(c => 
                    c.name.toLowerCase().includes(searchFilter) || 
                    (c.organization_name && c.organization_name.toLowerCase().includes(searchFilter)) ||
                    (c.admin_email && c.admin_email.toLowerCase().includes(searchFilter))
                );
            }
            
            renderClients(filtered);
        }
        
        function updateClientStats() {
            const total = allClients.length;
            const active = allClients.filter(c => c.subscription_status === 'active').length;
            const expiringSoon = allClients.filter(c => {
                const days = getDaysUntil(c.subscription_end_date);
                return c.subscription_status === 'active' && days !== null && days <= 30 && days > 0;
            }).length;
            const expired = allClients.filter(c => {
                const days = getDaysUntil(c.subscription_end_date);
                return days !== null && days <= 0;
            }).length;
            
            document.getElementById('stat-total-clients').textContent = total;
            document.getElementById('stat-active-clients').textContent = active;
            document.getElementById('stat-expiring-clients').textContent = expiringSoon;
            document.getElementById('stat-expired-clients').textContent = expired;
        }
        
        // ============================================
        // CLIENTES - PRECIO CALCULATOR
        // ============================================
        function updatePriceCalculation() {
            const countryId = document.getElementById('client-country-id').value;
            const allianceId = document.getElementById('client-alliance-id').value;
            
            const country = allCountries.find(c => c.id == countryId);
            const alliance = allAlliances.find(a => a.id == allianceId);
            
            const basePrice = country ? parseFloat(country.annual_price_usd) : 0;
            const discountPercent = alliance ? parseFloat(alliance.discount_percentage) : 0;
            const discountAmount = basePrice * (discountPercent / 100);
            const finalPrice = basePrice - discountAmount;
            const monthlyPrice = finalPrice / 12;
            
            document.getElementById('calc-base-price').textContent = formatCurrency(basePrice) + ' USD';
            
            if (discountPercent > 0) {
                document.getElementById('calc-discount-row').style.display = 'flex';
                document.getElementById('calc-discount-percent').textContent = discountPercent;
                document.getElementById('calc-discount-amount').textContent = '-' + formatCurrency(discountAmount) + ' USD';
            } else {
                document.getElementById('calc-discount-row').style.display = 'none';
            }
            
            document.getElementById('calc-final-price').textContent = formatCurrency(finalPrice) + ' USD';
            document.getElementById('calc-monthly-price').textContent = formatCurrency(monthlyPrice);
        }
        
        // ============================================
        // CLIENTES - CRUD
        // ============================================
        function editClient(id) {
            const client = allClients.find(c => c.id === id);
            if (!client) return;
            
            document.getElementById('modal-client-title').textContent = 'Editar Cliente';
            document.getElementById('client-id').value = id;
            document.getElementById('client-name').value = client.name || '';
            document.getElementById('client-organization-name').value = client.organization_name || '';
            document.getElementById('client-tax-id').value = client.tax_id || '';
            document.getElementById('client-employee-range').value = client.employee_range || '';
            document.getElementById('client-country-id').value = client.country_id || '';
            document.getElementById('client-type-id').value = client.client_type_id || '';
            document.getElementById('client-city').value = client.city || '';
            document.getElementById('client-phone').value = client.phone || '';
            document.getElementById('client-address').value = client.address || '';
            document.getElementById('client-admin-name').value = client.admin_name || '';
            document.getElementById('client-email').value = client.admin_email || '';
            document.getElementById('client-billing-email').value = client.billing_email || '';
            document.getElementById('client-sales-channel-id').value = client.sales_channel_id || '';
            document.getElementById('client-alliance-id').value = client.alliance_id || '';
            document.getElementById('client-api-key').value = client.api_key || '';
            document.getElementById('client-deployment-url').value = client.deployment_url || '';
            document.getElementById('client-supabase-url').value = client.supabase_url || '';
            document.getElementById('client-supabase-anon-key').value = client.supabase_anon_key || '';
            document.getElementById('client-supabase-service-key').value = client.supabase_service_key || '';
            document.getElementById('client-postgres-password').value = client.postgres_password || '';
            document.getElementById('client-project-email').value = client.project_email || '';
            document.getElementById('client-project-email-password').value = client.project_email_password || '';
            document.getElementById('client-internal-notes').value = client.internal_notes || '';
            
            updatePriceCalculation();
            openModal('client');
        }
        
        async function saveClient() {
            const id = document.getElementById('client-id').value;
            const countryId = document.getElementById('client-country-id').value;
            const allianceId = document.getElementById('client-alliance-id').value;
            
            const country = allCountries.find(c => c.id == countryId);
            const alliance = allAlliances.find(a => a.id == allianceId);
            
            const basePrice = country ? parseFloat(country.annual_price_usd) : 0;
            const discountPercent = alliance ? parseFloat(alliance.discount_percentage) : 0;
            const finalPrice = basePrice - (basePrice * discountPercent / 100);
            
            const data = {
                name: document.getElementById('client-name').value,
                organization_name: document.getElementById('client-organization-name').value || null,
                tax_id: document.getElementById('client-tax-id').value || null,
                employee_range: document.getElementById('client-employee-range').value || null,
                country_id: countryId || null,
                client_type_id: document.getElementById('client-type-id').value || null,
                city: document.getElementById('client-city').value || null,
                phone: document.getElementById('client-phone').value || null,
                address: document.getElementById('client-address').value || null,
                admin_name: document.getElementById('client-admin-name').value,
                admin_email: document.getElementById('client-email').value,
                billing_email: document.getElementById('client-billing-email').value || null,
                sales_channel_id: document.getElementById('client-sales-channel-id').value || null,
                alliance_id: allianceId || null,
                base_price_usd: basePrice,
                discount_percentage: discountPercent,
                final_price_usd: finalPrice,
                api_key: document.getElementById('client-api-key').value,
                deployment_url: document.getElementById('client-deployment-url').value || null,
                supabase_url: document.getElementById('client-supabase-url').value,
                supabase_anon_key: document.getElementById('client-supabase-anon-key').value,
                supabase_service_key: document.getElementById('client-supabase-service-key').value || null,
                postgres_password: document.getElementById('client-postgres-password').value || null,
                project_email: document.getElementById('client-project-email').value || null,
                project_email_password: document.getElementById('client-project-email-password').value || null,
                internal_notes: document.getElementById('client-internal-notes').value || null,
                updated_at: new Date().toISOString()
            };
            
            if (!data.name || !data.admin_name || !data.admin_email || !data.api_key || !data.supabase_url || !data.supabase_anon_key) {
                showToast('Todos los campos marcados con * son requeridos', 'error');
                return;
            }
            
            try {
                const url = id 
                    ? `${SUPABASE_CONFIG.url}/rest/v1/clients?id=eq.${id}`
                    : `${SUPABASE_CONFIG.url}/rest/v1/clients`;
                
                await fetch(url, {
                    method: id ? 'PATCH' : 'POST',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                closeModal('client');
                await loadClients();
                showToast('Cliente guardado correctamente', 'success');
            } catch (error) {
                console.error('Error guardando cliente:', error);
                showToast('Error al guardar el cliente', 'error');
            }
        }
        
        function viewClient(id) {
            const client = allClients.find(c => c.id === id);
            if (!client) return;
            
            currentViewClientId = id;
            
            const country = allCountries.find(co => co.id === client.country_id);
            const clientType = allClientTypes.find(t => t.id === client.client_type_id);
            const channel = allSalesChannels.find(ch => ch.id === client.sales_channel_id);
            const alliance = allAlliances.find(a => a.id === client.alliance_id);
            const daysUntil = getDaysUntil(client.subscription_end_date);
            
            const clientRenewals = allRenewals.filter(r => r.client_id === id);
            
            document.getElementById('view-client-name-title').textContent = client.name;
            
            document.getElementById('view-client-content').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1rem;">
                            <i class="bi bi-info-circle"></i> Informaci칩n General
                        </h4>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Pa칤s:</td><td>${country ? `${country.flag_emoji || ''} ${country.name}` : '-'}</td></tr>
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Tipo:</td><td>${clientType ? `${clientType.icon || ''} ${clientType.name}` : '-'}</td></tr>
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">NIT/RFC:</td><td>${client.tax_id || '-'}</td></tr>
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Ciudad:</td><td>${client.city || '-'}</td></tr>
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Empleados:</td><td>${client.employee_range || '-'}</td></tr>
                        </table>
                        
                        <h4 style="color: var(--primary-color); margin: 1.5rem 0 1rem; font-size: 1rem;">
                            <i class="bi bi-person-badge"></i> Contacto
                        </h4>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Admin:</td><td>${client.admin_name}</td></tr>
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Email:</td><td>${client.admin_email}</td></tr>
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Tel칠fono:</td><td>${client.phone || '-'}</td></tr>
                        </table>
                        
                        <h4 style="color: var(--primary-color); margin: 1.5rem 0 1rem; font-size: 1rem;">
                            <i class="bi bi-database"></i> T칠cnico
                        </h4>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">API Key:</td><td><code>${client.api_key}</code></td></tr>
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Supabase:</td><td>${client.supabase_url ? '九 Configurado' : '仇 Pendiente'}</td></tr>
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Versi칩n BD:</td><td>v${client.schema_version || 0}</td></tr>
                        </table>
                    </div>
                    
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1rem;">
                            <i class="bi bi-calendar-check"></i> Suscripci칩n
                        </h4>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Estado:</span>
                                <span class="badge badge-${getStatusClass(client.subscription_status)}">${getStatusLabel(client.subscription_status)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Inicio:</span>
                                <span>${formatDate(client.subscription_start_date)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Vence:</span>
                                <span>${formatDate(client.subscription_end_date)}</span>
                            </div>
                            ${daysUntil !== null ? `<div style="display: flex; justify-content: space-between;"><span>D칤as restantes:</span><span class="${daysUntil <= 30 ? 'days-danger' : ''}" style="font-weight: bold;">${daysUntil}</span></div>` : ''}
                        </div>
                        
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1rem;">
                            <i class="bi bi-currency-dollar"></i> Precio
                        </h4>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Base:</span>
                                <span>${formatCurrency(client.base_price_usd)} USD</span>
                            </div>
                            ${client.discount_percentage > 0 ? `<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;"><span>Descuento:</span><span>-${client.discount_percentage}%</span></div>` : ''}
                            <div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #dee2e6; padding-top: 0.5rem;">
                                <span>Final:</span>
                                <span style="color: var(--primary-color);">${formatCurrency(client.final_price_usd || client.base_price_usd)} USD</span>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1rem;">
                            <i class="bi bi-cart-check"></i> Comercial
                        </h4>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Canal:</td><td>${channel ? channel.name : '-'}</td></tr>
                            <tr><td style="padding: 0.3rem 0; color: #6c757d;">Alianza:</td><td>${alliance ? `${alliance.name} (${alliance.discount_percentage}%)` : 'Ninguna'}</td></tr>
                        </table>
                    </div>
                </div>
                
                <h4 style="color: var(--primary-color); margin: 2rem 0 1rem; font-size: 1rem;">
                    <i class="bi bi-receipt"></i> Historial de Pagos
                </h4>
                <table style="width: 100%; font-size: 0.9rem;">
                    <thead style="background: #f8f9fa;">
                        <tr>
                            <th style="padding: 0.5rem;">#</th>
                            <th style="padding: 0.5rem;">Per칤odo</th>
                            <th style="padding: 0.5rem;">Monto</th>
                            <th style="padding: 0.5rem;">Estado</th>
                            <th style="padding: 0.5rem;">Fecha Pago</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${clientRenewals.length > 0 ? clientRenewals.map(r => `
                            <tr>
                                <td style="padding: 0.5rem;">${r.renewal_number}</td>
                                <td style="padding: 0.5rem;">${formatDate(r.period_start)} - ${formatDate(r.period_end)}</td>
                                <td style="padding: 0.5rem;">${formatCurrency(r.final_amount_usd)}</td>
                                <td style="padding: 0.5rem;"><span class="badge badge-${getStatusClass(r.payment_status)}">${getStatusLabel(r.payment_status)}</span></td>
                                <td style="padding: 0.5rem;">${formatDate(r.payment_date)}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="5" style="text-align: center; padding: 1rem; color: #6c757d;">Sin pagos registrados</td></tr>'}
                    </tbody>
                </table>
            `;
            
            openModal('view-client');
        }
        
        function editClientFromView() {
            closeModal('view-client');
            if (currentViewClientId) {
                editClient(currentViewClientId);
            }
        }
        // ============================================
        // RENOVACIONES
        // ============================================
        async function loadRenewals() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/renewals?select=*,clients(name)&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                allRenewals = await response.json();
                renderRenewals(allRenewals);
                updateRenewalStats();
            } catch (error) {
                console.error('Error cargando renovaciones:', error);
                allRenewals = [];
            }
        }
        
        function renderRenewals(renewals) {
            const tbody = document.getElementById('table-renewals');
            if (!tbody) return;
            
            if (renewals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="bi bi-credit-card"></i><p>No hay pagos registrados</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = renewals.map(r => `
                <tr>
                    <td><strong>${r.clients?.name || 'N/A'}</strong></td>
                    <td>${formatDate(r.period_start)} - ${formatDate(r.period_end)}</td>
                    <td><strong>${formatCurrency(r.final_amount_usd)}</strong></td>
                    <td>${r.payment_method || '-'}</td>
                    <td><span class="badge badge-${getStatusClass(r.payment_status)}">${getStatusLabel(r.payment_status)}</span></td>
                    <td>${formatDate(r.payment_date)}</td>
                    <td>
                        <button class="btn-action" onclick="viewRenewalDetail(${r.id})" title="Ver detalle"><i class="bi bi-eye"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterRenewals() {
            const yearFilter = document.getElementById('filter-renewal-year').value;
            const monthFilter = document.getElementById('filter-renewal-month').value;
            const statusFilter = document.getElementById('filter-renewal-status').value;
            
            let filtered = allRenewals;
            
            if (yearFilter) {
                filtered = filtered.filter(r => new Date(r.payment_date || r.created_at).getFullYear() == yearFilter);
            }
            if (monthFilter) {
                filtered = filtered.filter(r => (new Date(r.payment_date || r.created_at).getMonth() + 1) == monthFilter);
            }
            if (statusFilter) {
                filtered = filtered.filter(r => r.payment_status === statusFilter);
            }
            
            renderRenewals(filtered);
        }
        
        function updateRenewalStats() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            const thisYearRenewals = allRenewals.filter(r => {
                const date = new Date(r.payment_date || r.created_at);
                return date.getFullYear() === currentYear && r.payment_status === 'paid';
            });
            
            const thisMonthRenewals = thisYearRenewals.filter(r => {
                const date = new Date(r.payment_date || r.created_at);
                return (date.getMonth() + 1) === currentMonth;
            });
            
            const pending = allRenewals.filter(r => r.payment_status === 'pending');
            
            const totalThisYear = thisYearRenewals.reduce((sum, r) => sum + parseFloat(r.final_amount_usd || 0), 0);
            const totalThisMonth = thisMonthRenewals.reduce((sum, r) => sum + parseFloat(r.final_amount_usd || 0), 0);
            
            document.getElementById('stat-payments-year').textContent = formatCurrency(totalThisYear);
            document.getElementById('stat-payments-month').textContent = formatCurrency(totalThisMonth);
            document.getElementById('stat-payments-count').textContent = thisYearRenewals.length;
            document.getElementById('stat-payments-pending').textContent = pending.length;
        }
        
        function openRenewalForClient(clientId) {
            clearRenewalForm();
            document.getElementById('renewal-client-id').value = clientId;
            loadClientPriceForRenewal();
            openModal('renewal');
        }
        
        function loadClientPriceForRenewal() {
            const clientId = document.getElementById('renewal-client-id').value;
            const client = allClients.find(c => c.id == clientId);
            const infoDiv = document.getElementById('renewal-client-info');
            
            if (client) {
                const country = allCountries.find(co => co.id === client.country_id);
                const alliance = allAlliances.find(a => a.id === client.alliance_id);
                
                document.getElementById('renewal-client-country').textContent = country ? `${country.flag_emoji || ''} ${country.name}` : '-';
                document.getElementById('renewal-client-base-price').textContent = formatCurrency(client.base_price_usd);
                document.getElementById('renewal-client-alliance').textContent = alliance ? `${alliance.name} (${alliance.discount_percentage}%)` : 'Ninguna';
                document.getElementById('renewal-client-final-price').textContent = formatCurrency(client.final_price_usd || client.base_price_usd);
                
                document.getElementById('renewal-amount').value = client.final_price_usd || client.base_price_usd || '';
                
                // Calcular fechas sugeridas
                const today = new Date();
                const endDate = client.subscription_end_date ? new Date(client.subscription_end_date) : today;
                const startDate = endDate > today ? endDate : today;
                const newEndDate = new Date(startDate);
                newEndDate.setFullYear(newEndDate.getFullYear() + 1);
                
                document.getElementById('renewal-period-start').value = startDate.toISOString().split('T')[0];
                document.getElementById('renewal-period-end').value = newEndDate.toISOString().split('T')[0];
                
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        async function saveRenewal() {
            const clientId = document.getElementById('renewal-client-id').value;
            const client = allClients.find(c => c.id == clientId);
            
            if (!client) {
                showToast('Seleccione un cliente', 'error');
                return;
            }
            
            // Contar renovaciones existentes para este cliente
            const existingRenewals = allRenewals.filter(r => r.client_id == clientId);
            const renewalNumber = existingRenewals.length + 1;
            
            const data = {
                client_id: parseInt(clientId),
                renewal_number: renewalNumber,
                period_start: document.getElementById('renewal-period-start').value,
                period_end: document.getElementById('renewal-period-end').value,
                base_price_usd: client.base_price_usd || 0,
                discount_percentage: client.discount_percentage || 0,
                discount_amount_usd: (client.base_price_usd || 0) * ((client.discount_percentage || 0) / 100),
                final_amount_usd: parseFloat(document.getElementById('renewal-amount').value) || 0,
                payment_method: document.getElementById('renewal-payment-method').value || null,
                payment_status: document.getElementById('renewal-payment-status').value,
                payment_date: document.getElementById('renewal-payment-date').value || null,
                payment_reference: document.getElementById('renewal-payment-reference').value || null,
                sales_channel_id: client.sales_channel_id,
                alliance_id: client.alliance_id,
                notes: document.getElementById('renewal-notes').value || null,
                created_at: new Date().toISOString()
            };
            
            if (!data.period_start || !data.period_end || !data.final_amount_usd) {
                showToast('Complete los campos requeridos', 'error');
                return;
            }
            
            try {
                // Crear renovaci칩n
                await fetch(`${SUPABASE_CONFIG.url}/rest/v1/renewals`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                // Si est치 pagado, actualizar cliente
                if (data.payment_status === 'paid') {
                    await fetch(`${SUPABASE_CONFIG.url}/rest/v1/clients?id=eq.${clientId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            subscription_status: 'active',
                            subscription_start_date: data.period_start,
                            subscription_end_date: data.period_end,
                            updated_at: new Date().toISOString()
                        })
                    });
                    
                    // Generar comisi칩n si tiene canal
                    if (client.sales_channel_id) {
                        await generateCommission(data, client);
                    }
                }
                
                closeModal('renewal');
                await loadRenewals();
                await loadClients();
                await loadCommissions();
                showToast('Pago registrado correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al registrar el pago', 'error');
            }
        }
        
        // ============================================
        // COMISIONES
        // ============================================
        async function loadCommissions() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/commissions?select=*,clients(name),sales_channels(name)&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                allCommissions = await response.json();
                renderCommissions(allCommissions);
                updateCommissionStats();
            } catch (error) {
                console.error('Error cargando comisiones:', error);
                allCommissions = [];
            }
        }
        
        function renderCommissions(commissions) {
            const tbody = document.getElementById('table-commissions');
            if (!tbody) return;
            
            if (commissions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="bi bi-percent"></i><p>No hay comisiones registradas</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = commissions.map(c => `
                <tr>
                    <td><input type="checkbox" class="commission-checkbox" value="${c.id}" ${c.status === 'paid' ? 'disabled' : ''}></td>
                    <td><strong>${c.sales_channels?.name || 'N/A'}</strong></td>
                    <td>${c.clients?.name || 'N/A'}</td>
                    <td>${formatCurrency(c.sale_amount_usd)}</td>
                    <td>${c.commission_percentage}%</td>
                    <td><strong>${formatCurrency(c.commission_amount_usd)}</strong></td>
                    <td><span class="badge badge-${getStatusClass(c.status)}">${getStatusLabel(c.status)}</span></td>
                    <td>${formatDate(c.payment_date)}</td>
                </tr>
            `).join('');
        }
        
        function filterCommissions() {
            const yearFilter = document.getElementById('filter-commission-year').value;
            const monthFilter = document.getElementById('filter-commission-month').value;
            const statusFilter = document.getElementById('filter-commission-status').value;
            const channelFilter = document.getElementById('filter-commission-channel').value;
            
            let filtered = allCommissions;
            
            if (yearFilter) filtered = filtered.filter(c => c.period_year == yearFilter);
            if (monthFilter) filtered = filtered.filter(c => c.period_month == monthFilter);
            if (statusFilter) filtered = filtered.filter(c => c.status === statusFilter);
            if (channelFilter) filtered = filtered.filter(c => c.sales_channel_id == channelFilter);
            
            renderCommissions(filtered);
        }
        
        function updateCommissionStats() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            const thisMonthCommissions = allCommissions.filter(c => c.period_year === currentYear && c.period_month === currentMonth);
            
            const totalSales = thisMonthCommissions.reduce((sum, c) => sum + parseFloat(c.sale_amount_usd || 0), 0);
            const totalCommissions = thisMonthCommissions.reduce((sum, c) => sum + parseFloat(c.commission_amount_usd || 0), 0);
            const paidCommissions = thisMonthCommissions.filter(c => c.status === 'paid').reduce((sum, c) => sum + parseFloat(c.commission_amount_usd || 0), 0);
            const pendingCommissions = totalCommissions - paidCommissions;
            
            document.getElementById('stat-commission-sales').textContent = formatCurrency(totalSales);
            document.getElementById('stat-commission-total').textContent = formatCurrency(totalCommissions);
            document.getElementById('stat-commission-paid').textContent = formatCurrency(paidCommissions);
            document.getElementById('stat-commission-pending').textContent = formatCurrency(pendingCommissions);
        }
        
        async function generateCommission(renewalData, client) {
            const channel = allSalesChannels.find(ch => ch.id === client.sales_channel_id);
            if (!channel) return;
            
            const today = new Date();
            const commissionAmount = renewalData.final_amount_usd * (channel.commission_percentage / 100);
            
            const commission = {
                sales_channel_id: channel.id,
                renewal_id: null, // Se actualizar칤a despu칠s si tuvi칠ramos el ID
                client_id: client.id,
                period_year: today.getFullYear(),
                period_month: today.getMonth() + 1,
                sale_amount_usd: renewalData.final_amount_usd,
                commission_percentage: channel.commission_percentage,
                commission_amount_usd: commissionAmount,
                status: 'calculated',
                created_at: new Date().toISOString()
            };
            
            try {
                await fetch(`${SUPABASE_CONFIG.url}/rest/v1/commissions`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(commission)
                });
            } catch (error) {
                console.error('Error generando comisi칩n:', error);
            }
        }
        
        async function approveSelectedCommissions() {
            const selected = Array.from(document.querySelectorAll('.commission-checkbox:checked')).map(cb => cb.value);
            
            if (selected.length === 0) {
                showToast('Seleccione al menos una comisi칩n', 'error');
                return;
            }
            
            try {
                for (const id of selected) {
                    await fetch(`${SUPABASE_CONFIG.url}/rest/v1/commissions?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: 'approved',
                            approved_by: currentUser.id,
                            approved_at: new Date().toISOString()
                        })
                    });
                }
                
                await loadCommissions();
                showToast(`${selected.length} comisiones aprobadas`, 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al aprobar comisiones', 'error');
            }
        }
        
        async function markSelectedAsPaid() {
            const selected = Array.from(document.querySelectorAll('.commission-checkbox:checked')).map(cb => cb.value);
            
            if (selected.length === 0) {
                showToast('Seleccione al menos una comisi칩n', 'error');
                return;
            }
            
            const reference = prompt('Ingrese la referencia de pago:');
            if (!reference) return;
            
            try {
                for (const id of selected) {
                    await fetch(`${SUPABASE_CONFIG.url}/rest/v1/commissions?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: 'paid',
                            payment_date: new Date().toISOString().split('T')[0],
                            payment_reference: reference
                        })
                    });
                }
                
                await loadCommissions();
                showToast(`${selected.length} comisiones marcadas como pagadas`, 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al actualizar comisiones', 'error');
            }
        }
        
        function exportCommissions() {
            // Implementar exportaci칩n a Excel/CSV
            showToast('Funci칩n de exportaci칩n en desarrollo', 'info');
        }
        
        // ============================================
        // DASHBOARD
        // ============================================
        function loadDashboard() {
            // Stats principales
            const totalClients = allClients.length;
            const activeClients = allClients.filter(c => c.subscription_status === 'active').length;
            const expiringSoon = allClients.filter(c => {
                const days = getDaysUntil(c.subscription_end_date);
                return c.subscription_status === 'active' && days !== null && days <= 30 && days > 0;
            }).length;
            const suspended = allClients.filter(c => c.subscription_status === 'suspended').length;
            
            document.getElementById('dash-total-clients').textContent = totalClients;
            document.getElementById('dash-active-clients').textContent = activeClients;
            document.getElementById('dash-expiring-clients').textContent = expiringSoon;
            document.getElementById('dash-suspended-clients').textContent = suspended;
            
            // Ingresos
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            const yearIncome = allRenewals
                .filter(r => new Date(r.payment_date || r.created_at).getFullYear() === currentYear && r.payment_status === 'paid')
                .reduce((sum, r) => sum + parseFloat(r.final_amount_usd || 0), 0);
            
            const monthIncome = allRenewals
                .filter(r => {
                    const d = new Date(r.payment_date || r.created_at);
                    return d.getFullYear() === currentYear && (d.getMonth() + 1) === currentMonth && r.payment_status === 'paid';
                })
                .reduce((sum, r) => sum + parseFloat(r.final_amount_usd || 0), 0);
            
            document.getElementById('dash-year-income').textContent = formatCurrency(yearIncome);
            document.getElementById('dash-month-income').textContent = formatCurrency(monthIncome);
            
            // Comisiones del mes
            const monthCommissions = allCommissions
                .filter(c => c.period_year === currentYear && c.period_month === currentMonth)
                .reduce((sum, c) => sum + parseFloat(c.commission_amount_usd || 0), 0);
            
            const pendingCommissions = allCommissions
                .filter(c => c.status !== 'paid')
                .reduce((sum, c) => sum + parseFloat(c.commission_amount_usd || 0), 0);
            
            document.getElementById('dash-month-commissions').textContent = formatCurrency(monthCommissions);
            document.getElementById('dash-pending-commissions').textContent = formatCurrency(pendingCommissions);
            
            // Distribuci칩n por pa칤s
            renderDistributionByCountry();
            
            // Distribuci칩n por canal
            renderDistributionByChannel();
            
            // Distribuci칩n por tipo
            renderDistributionByType();
            
            // Pr칩ximos vencimientos
            renderUpcomingExpirations();
        }
        
        function renderDistributionByCountry() {
            const container = document.getElementById('dash-by-country');
            if (!container) return;
            
            const byCountry = {};
            allClients.forEach(c => {
                const country = allCountries.find(co => co.id === c.country_id);
                const key = country ? `${country.flag_emoji || ''} ${country.name}` : 'Sin pa칤s';
                byCountry[key] = (byCountry[key] || 0) + 1;
            });
            
            const sorted = Object.entries(byCountry).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            container.innerHTML = sorted.map(([name, count]) => `
                <div class="dash-chip">
                    <span>${name}</span>
                    <span class="chip-count">${count}</span>
                </div>
            `).join('') || '<p style="color: #6c757d; font-size: 0.9rem;">Sin datos</p>';
        }
        
        function renderDistributionByChannel() {
            const container = document.getElementById('dash-by-channel');
            if (!container) return;
            
            const byChannel = {};
            allClients.forEach(c => {
                const channel = allSalesChannels.find(ch => ch.id === c.sales_channel_id);
                const key = channel ? channel.name : 'Sin canal';
                byChannel[key] = (byChannel[key] || 0) + 1;
            });
            
            const sorted = Object.entries(byChannel).sort((a, b) => b[1] - a[1]);
            
            container.innerHTML = sorted.map(([name, count]) => `
                <div class="dash-chip">
                    <span>${name}</span>
                    <span class="chip-count">${count}</span>
                </div>
            `).join('') || '<p style="color: #6c757d; font-size: 0.9rem;">Sin datos</p>';
        }
        
        function renderDistributionByType() {
            const container = document.getElementById('dash-by-type');
            if (!container) return;
            
            const byType = {};
            allClients.forEach(c => {
                const type = allClientTypes.find(t => t.id === c.client_type_id);
                const key = type ? `${type.icon || ''} ${type.name}` : 'Sin tipo';
                byType[key] = (byType[key] || 0) + 1;
            });
            
            const sorted = Object.entries(byType).sort((a, b) => b[1] - a[1]);
            
            container.innerHTML = sorted.map(([name, count]) => `
                <div class="dash-chip">
                    <span>${name}</span>
                    <span class="chip-count">${count}</span>
                </div>
            `).join('') || '<p style="color: #6c757d; font-size: 0.9rem;">Sin datos</p>';
        }
        
        function renderUpcomingExpirations() {
            const tbody = document.getElementById('dash-expirations');
            if (!tbody) return;
            
            const expiring = allClients
                .filter(c => {
                    const days = getDaysUntil(c.subscription_end_date);
                    return days !== null && days <= 60;
                })
                .sort((a, b) => new Date(a.subscription_end_date) - new Date(b.subscription_end_date))
                .slice(0, 5);
            
            if (expiring.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6c757d;">No hay vencimientos pr칩ximos</td></tr>';
                return;
            }
            
            tbody.innerHTML = expiring.map(c => {
                const days = getDaysUntil(c.subscription_end_date);
                let daysClass = '';
                if (days <= 7) daysClass = 'days-danger';
                else if (days <= 30) daysClass = 'days-warning';
                
                return `
                <tr>
                    <td>${c.name}</td>
                    <td>${formatDate(c.subscription_end_date)}</td>
                    <td class="${daysClass}">${days} d칤as</td>
                    <td><button class="btn-action" onclick="openRenewalForClient(${c.id})" title="Renovar"><i class="bi bi-arrow-repeat"></i></button></td>
                </tr>
            `}).join('');
        }
        
        // ============================================
        // SOLICITUDES DE SOPORTE
        // ============================================
        async function loadRequests() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/support_requests?select=*,clients(name)&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                allRequests = await response.json();
                renderRequests(allRequests);
                updateRequestStats();
            } catch (error) {
                console.error('Error cargando solicitudes:', error);
            }
        }
        
        function renderRequests(requests) {
            const tbody = document.getElementById('table-solicitudes');
            
            if (requests.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="bi bi-inbox"></i><p>No hay solicitudes</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = requests.map(r => `
                <tr>
                    <td>#${r.id}</td>
                    <td>${r.clients?.name || 'N/A'}</td>
                    <td><span class="badge badge-${r.request_type === 'soporte' ? 'soporte' : 'modificacion'}">${r.request_type === 'soporte' ? '游댢 Soporte' : '九 Modificaci칩n'}</span></td>
                    <td>${r.description.substring(0, 50)}${r.description.length > 50 ? '...' : ''}</td>
                    <td><span class="badge badge-${getStatusClass(r.status)}">${getStatusLabel(r.status)}</span></td>
                    <td>${formatDateTime(r.created_at)}</td>
                    <td>
                        <button class="btn-action" onclick="viewRequest(${r.id})" title="Ver"><i class="bi bi-eye"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterRequests() {
            const statusFilter = document.getElementById('filter-status').value;
            const typeFilter = document.getElementById('filter-type').value;
            
            let filtered = allRequests;
            
            if (statusFilter) filtered = filtered.filter(r => r.status === statusFilter);
            if (typeFilter) filtered = filtered.filter(r => r.request_type === typeFilter);
            
            renderRequests(filtered);
        }
        
        function updateRequestStats() {
            document.getElementById('stat-pendientes').textContent = allRequests.filter(r => r.status === 'pendiente').length;
            document.getElementById('stat-proceso').textContent = allRequests.filter(r => r.status === 'en_proceso').length;
            document.getElementById('stat-resueltas').textContent = allRequests.filter(r => r.status === 'resuelto').length;
            document.getElementById('stat-total-requests').textContent = allRequests.length;
        }
        
        function viewRequest(id) {
            const request = allRequests.find(r => r.id === id);
            if (!request) return;
            
            currentRequestId = id;
            
            document.getElementById('view-request-id').textContent = id;
            document.getElementById('view-client-name').textContent = request.clients?.name || 'N/A';
            document.getElementById('view-request-type').textContent = request.request_type === 'soporte' ? '游댢 Soporte' : '九 Modificaci칩n';
            document.getElementById('view-request-status').innerHTML = `<span class="badge badge-${getStatusClass(request.status)}">${getStatusLabel(request.status)}</span>`;
            document.getElementById('view-request-date').textContent = formatDateTime(request.created_at);
            document.getElementById('view-request-description').textContent = request.description;
            document.getElementById('edit-status').value = request.status;
            document.getElementById('edit-notes').value = request.admin_notes || '';
            
            const screenshotContainer = document.getElementById('view-screenshot-container');
            if (request.screenshot_url) {
                document.getElementById('view-screenshot').src = request.screenshot_url;
                screenshotContainer.style.display = 'block';
            } else {
                screenshotContainer.style.display = 'none';
            }
            
            openModal('view-request');
        }
        
        async function updateRequest() {
            const status = document.getElementById('edit-status').value;
            const notes = document.getElementById('edit-notes').value;
            
            try {
                await fetch(`${SUPABASE_CONFIG.url}/rest/v1/support_requests?id=eq.${currentRequestId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: status,
                        admin_notes: notes,
                        updated_at: new Date().toISOString(),
                        resolved_at: status === 'resuelto' ? new Date().toISOString() : null
                    })
                });
                
                closeModal('view-request');
                loadRequests();
                showToast('Solicitud actualizada', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al actualizar', 'error');
            }
        }
        
        // ============================================
        // ACTUALIZACIONES
        // ============================================
        async function loadUpdates() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/updates?select=*&order=published_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                allUpdates = await response.json();
                renderUpdates(allUpdates);
                populateModuleFilter();
            } catch (error) {
                console.error('Error cargando actualizaciones:', error);
            }
        }
        
        function renderUpdates(updates) {
            const tbody = document.getElementById('table-actualizaciones');
            
            if (updates.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="bi bi-megaphone"></i><p>No hay actualizaciones</p></div></td></tr>`;
                return;
            }
            
            tbody.innerHTML = updates.map(u => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = u.detail;
                const plainText = tempDiv.textContent || tempDiv.innerText || '';
                
                return `
                <tr>
                    <td><strong>${u.module}</strong></td>
                    <td>${u.feature}</td>
                    <td><code>${u.version}</code></td>
                    <td>${plainText.substring(0, 60)}${plainText.length > 60 ? '...' : ''}</td>
                    <td><span class="badge ${u.is_published ? 'badge-success' : 'badge-pending'}">${u.is_published ? 'Publicado' : 'Borrador'}</span></td>
                    <td>${formatDate(u.published_at)}</td>
                    <td>
                        <button class="btn-action" onclick="editUpdate(${u.id})" title="Editar"><i class="bi bi-pencil"></i></button>
                        <button class="btn-action" onclick="toggleUpdateStatus(${u.id}, ${u.is_published})" title="${u.is_published ? 'Despublicar' : 'Publicar'}">
                            <i class="bi bi-${u.is_published ? 'eye-slash' : 'eye'}"></i>
                        </button>
                        <button class="btn-action btn-danger" onclick="deleteUpdate(${u.id})" title="Eliminar"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
        }
        
        function populateModuleFilter() {
            const modules = [...new Set(allUpdates.map(u => u.module))];
            const select = document.getElementById('filter-module');
            select.innerHTML = '<option value="">Todos los m칩dulos</option>' + 
                modules.map(m => `<option value="${m}">${m}</option>`).join('');
        }
        
        function filterUpdates() {
            const moduleFilter = document.getElementById('filter-module').value;
            const publishedFilter = document.getElementById('filter-published').value;
            
            let filtered = allUpdates;
            
            if (moduleFilter) filtered = filtered.filter(u => u.module === moduleFilter);
            if (publishedFilter !== '') filtered = filtered.filter(u => u.is_published === (publishedFilter === 'true'));
            
            renderUpdates(filtered);
        }
        
        function editUpdate(id) {
            const update = allUpdates.find(u => u.id === id);
            if (!update) return;
            
            document.getElementById('modal-update-title').textContent = 'Editar Actualizaci칩n';
            document.getElementById('update-id').value = id;
            document.getElementById('update-module').value = update.module;
            document.getElementById('update-feature').value = update.feature;
            document.getElementById('update-version').value = update.version;
            document.getElementById('update-published').checked = update.is_published;
            
            if (quillEditor) quillEditor.root.innerHTML = update.detail || '';
            
            openModal('update');
        }
        
        async function saveUpdate() {
            const id = document.getElementById('update-id').value;
            const isPublished = document.getElementById('update-published').checked;
            const detailHTML = quillEditor.root.innerHTML;
            
            const data = {
                module: document.getElementById('update-module').value,
                feature: document.getElementById('update-feature').value,
                version: document.getElementById('update-version').value,
                detail: detailHTML,
                is_published: isPublished,
                updated_at: new Date().toISOString()
            };
            
            if (!data.module || !data.feature || !data.version || !detailHTML || detailHTML === '<p><br></p>') {
                showToast('Todos los campos son requeridos', 'error');
                return;
            }
            
            if (!id && isPublished) data.published_at = new Date().toISOString();
            if (id && isPublished) {
                const existing = allUpdates.find(u => u.id === parseInt(id));
                if (existing && !existing.is_published) data.published_at = new Date().toISOString();
            }
            
            try {
                const url = id 
                    ? `${SUPABASE_CONFIG.url}/rest/v1/updates?id=eq.${id}`
                    : `${SUPABASE_CONFIG.url}/rest/v1/updates`;
                
                await fetch(url, {
                    method: id ? 'PATCH' : 'POST',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                closeModal('update');
                loadUpdates();
                showToast('Actualizaci칩n guardada', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al guardar', 'error');
            }
        }
        
        async function toggleUpdateStatus(id, currentStatus) {
            try {
                const data = { 
                    is_published: !currentStatus,
                    updated_at: new Date().toISOString()
                };
                if (!currentStatus) data.published_at = new Date().toISOString();
                
                await fetch(`${SUPABASE_CONFIG.url}/rest/v1/updates?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                loadUpdates();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        async function deleteUpdate(id) {
            if (!confirm('쮼st치 seguro de eliminar esta actualizaci칩n?')) return;
            
            try {
                await fetch(`${SUPABASE_CONFIG.url}/rest/v1/updates?id=eq.${id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                    }
                });
                loadUpdates();
                showToast('Actualizaci칩n eliminada', 'success');
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // ============================================
        // USUARIOS
        // ============================================
        async function loadUsers() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/users?select=*&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                const users = await response.json();
                renderUsers(users);
            } catch (error) {
                console.error('Error cargando usuarios:', error);
            }
        }
        
        function renderUsers(users) {
            const tbody = document.getElementById('table-usuarios');
            
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td><strong>${u.username}</strong></td>
                    <td>${u.full_name}</td>
                    <td>${u.email}</td>
                    <td>${u.last_login ? formatDateTime(u.last_login) : 'Nunca'}</td>
                    <td><span class="badge ${u.is_active ? 'badge-success' : 'badge-closed'}">${u.is_active ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <button class="btn-action" onclick="editUser(${u.id})" title="Editar"><i class="bi bi-pencil"></i></button>
                        <button class="btn-action" onclick="toggleUserStatus(${u.id}, ${u.is_active})" title="${u.is_active ? 'Desactivar' : 'Activar'}">
                            <i class="bi bi-${u.is_active ? 'pause' : 'play'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function editUser(id) {
            const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/users?id=eq.${id}`, {
                headers: {
                    'apikey': SUPABASE_CONFIG.anonKey,
                    'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                }
            });
            const users = await response.json();
            const user = users[0];
            if (!user) return;
            
            document.getElementById('modal-user-title').textContent = 'Editar Usuario';
            document.getElementById('user-id').value = id;
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-fullname').value = user.full_name;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-password').value = '';
            document.getElementById('password-hint').textContent = '(dejar vac칤o para mantener)';
            
            openModal('user');
        }
        
        async function saveUser() {
            const id = document.getElementById('user-id').value;
            const data = {
                username: document.getElementById('user-username').value,
                full_name: document.getElementById('user-fullname').value,
                email: document.getElementById('user-email').value,
                updated_at: new Date().toISOString()
            };
            
            const password = document.getElementById('user-password').value;
            if (password || !id) {
                if (!password && !id) {
                    showToast('La contrase침a es requerida para nuevos usuarios', 'error');
                    return;
                }
                if (password) data.password = password;
            }
            
            if (!data.username || !data.full_name || !data.email) {
                showToast('Todos los campos son requeridos', 'error');
                return;
            }
            
            try {
                const url = id 
                    ? `${SUPABASE_CONFIG.url}/rest/v1/users?id=eq.${id}`
                    : `${SUPABASE_CONFIG.url}/rest/v1/users`;
                
                await fetch(url, {
                    method: id ? 'PATCH' : 'POST',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                closeModal('user');
                loadUsers();
                showToast('Usuario guardado', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al guardar', 'error');
            }
        }
        
        async function toggleUserStatus(id, currentStatus) {
            if (id === currentUser.id) {
                showToast('No puedes desactivar tu propio usuario', 'error');
                return;
            }
            
            try {
                await fetch(`${SUPABASE_CONFIG.url}/rest/v1/users?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: !currentStatus })
                });
                loadUsers();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // ============================================
        // MIGRACIONES
        // ============================================
        async function loadMigrationStatus() {
            try {
                const logsResponse = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/migration_logs?select=*,clients(name)&order=executed_at.desc&limit=50`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                const logs = await logsResponse.json();
                
                renderMigrationStatus(allClients);
                renderMigrationLogs(logs);
                updateMigrationStats();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function renderMigrationStatus(clients) {
            const tbody = document.getElementById('table-migraciones');
            if (!tbody) return;
            
            const filter = document.getElementById('filter-migration-status')?.value || '';
            
            let filtered = clients;
            
            if (filter === 'updated') filtered = filtered.filter(c => c.supabase_url && (c.schema_version || 0) >= CURRENT_SCHEMA_VERSION);
            else if (filter === 'pending') filtered = filtered.filter(c => c.supabase_url && (c.schema_version || 0) < CURRENT_SCHEMA_VERSION);
            else if (filter === 'no-config') filtered = filtered.filter(c => !c.supabase_url);
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="bi bi-database"></i><p>No hay clientes</p></div></td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(c => {
                const hasConfig = c.supabase_url && c.supabase_anon_key;
                const hasServiceKey = c.supabase_service_key;
                const currentVersion = c.schema_version || 0;
                const isUpdated = currentVersion >= CURRENT_SCHEMA_VERSION;
                
                let statusBadge;
                if (!hasConfig) statusBadge = '<span class="badge badge-closed">Sin Configurar</span>';
                else if (currentVersion === 0) statusBadge = '<span class="badge badge-pending">Sin migraci칩n inicial</span>';
                else if (isUpdated) statusBadge = '<span class="badge badge-success">Actualizado</span>';
                else statusBadge = `<span class="badge badge-pending">${CURRENT_SCHEMA_VERSION - currentVersion} pendiente(s)</span>`;
                
                const serviceKeyIcon = hasServiceKey ? '九' : '丘멆잺';
                
                return `
                <tr>
                    <td><strong>${c.name}</strong> ${serviceKeyIcon}</td>
                    <td><code style="font-size: 0.75rem;">${c.supabase_url ? c.supabase_url.substring(8, 35) + '...' : 'No configurado'}</code></td>
                    <td><code>v${currentVersion}</code></td>
                    <td>${statusBadge}</td>
                    <td>${c.last_migration_at ? formatDateTime(c.last_migration_at) : 'Nunca'}</td>
                    <td>
                        ${hasConfig ? `<button class="btn-action" onclick="testClientConnection(${c.id})" title="Probar conexi칩n"><i class="bi bi-plug"></i></button>` : ''}
                        ${hasConfig && currentVersion > 0 && !isUpdated ? `<button class="btn-action btn-success" onclick="runMigrationForClient(${c.id})" title="Ejecutar migraciones"><i class="bi bi-arrow-repeat"></i></button>` : ''}
                    </td>
                </tr>
            `}).join('');
        }
        
        function renderMigrationLogs(logs) {
            const tbody = document.getElementById('table-migration-logs');
            if (!tbody) return;
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="bi bi-clock-history"></i><p>No hay historial</p></div></td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${log.clients?.name || 'N/A'}</td>
                    <td><code>v${log.migration_version}</code></td>
                    <td>${log.migration_name || '-'}</td>
                    <td><span class="badge ${log.status === 'success' ? 'badge-success' : 'badge-danger'}">${log.status === 'success' ? '칄xito' : 'Error'}</span></td>
                    <td>${log.execution_time_ms ? `${log.execution_time_ms}ms` : '-'}</td>
                    <td>${formatDateTime(log.executed_at)}</td>
                </tr>
            `).join('');
        }
        
        function updateMigrationStats() {
            const configured = allClients.filter(c => c.supabase_url);
            const updated = configured.filter(c => (c.schema_version || 0) >= CURRENT_SCHEMA_VERSION);
            const pending = configured.filter(c => (c.schema_version || 0) > 0 && (c.schema_version || 0) < CURRENT_SCHEMA_VERSION);
            
            document.getElementById('stat-mig-updated').textContent = updated.length;
            document.getElementById('stat-mig-pending').textContent = pending.length;
            document.getElementById('stat-mig-version').textContent = CURRENT_SCHEMA_VERSION;
            document.getElementById('stat-mig-total').textContent = allClients.length;
        }
        
        function openMigrationModal() {
            const clientSelect = document.getElementById('migration-client-id');
            clientSelect.innerHTML = '<option value="">Seleccione un cliente...</option>';
            
            const pendingClients = allClients.filter(c => 
                c.supabase_url && c.supabase_service_key && 
                (c.schema_version || 0) > 0 && (c.schema_version || 0) < CURRENT_SCHEMA_VERSION
            );
            
            pendingClients.forEach(c => {
                const pending = CURRENT_SCHEMA_VERSION - (c.schema_version || 0);
                clientSelect.innerHTML += `<option value="${c.id}">${c.name} (${pending} pendiente${pending > 1 ? 's' : ''})</option>`;
            });
            
            document.getElementById('migration-target').value = 'all';
            document.getElementById('single-client-select').style.display = 'none';
            document.getElementById('migration-results').style.display = 'none';
            
            openModal('migration');
        }
        
        async function runMigrations() {
            // Implementaci칩n simplificada - en producci칩n ser칤a m치s compleja
            showToast('Funci칩n de migraciones en desarrollo', 'info');
        }
        
        async function testClientConnection(clientId) {
            const client = allClients.find(c => c.id === clientId);
            if (!client) return;
            
            showToast(`Probando conexi칩n con ${client.name}...`, 'info');
            
            try {
                const response = await fetch(`${client.supabase_url}/rest/v1/`, {
                    headers: {
                        'apikey': client.supabase_anon_key,
                        'Authorization': `Bearer ${client.supabase_anon_key}`
                    }
                });
                
                if (response.ok) showToast(`九 Conexi칩n exitosa con ${client.name}`, 'success');
                else showToast(`仇 Error: ${response.status}`, 'error');
            } catch (error) {
                showToast(`仇 Error: ${error.message}`, 'error');
            }
        }
        
        function runMigrationForClient(clientId) {
            openMigrationModal();
            document.getElementById('migration-target').value = 'single';
            document.getElementById('single-client-select').style.display = 'block';
            document.getElementById('migration-client-id').value = clientId;
        }
        
        // ============================================
        // CONFIGURACI칍N
        // ============================================
        async function loadConfig() {
            try {
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/rest/v1/config?select=*&limit=1`,
                    {
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        }
                    }
                );
                const configs = await response.json();
                
                if (configs.length > 0) {
                    currentConfig = configs[0];
                    populateConfigForm(currentConfig);
                }
            } catch (error) {
                console.error('Error cargando configuraci칩n:', error);
            }
        }
        
        function populateConfigForm(config) {
            document.getElementById('config-site-name').value = config.site_name || '';
            document.getElementById('config-primary-color').value = config.primary_color || '#1D4E4F';
            document.getElementById('config-primary-color-picker').value = config.primary_color || '#1D4E4F';
            document.getElementById('config-secondary-color').value = config.secondary_color || '#2D8B7A';
            document.getElementById('config-secondary-color-picker').value = config.secondary_color || '#2D8B7A';
            document.getElementById('config-tertiary-color').value = config.tertiary_color || '';
            document.getElementById('config-tertiary-color-picker').value = config.tertiary_color || '#5FB09C';
            document.getElementById('config-logo-url').value = config.logo_url || '';
            document.getElementById('config-favicon-url').value = config.favicon_url || '';
            document.getElementById('config-hero-title').value = config.hero_title || '';
            document.getElementById('config-hero-subtitle').value = config.hero_subtitle || '';
            document.getElementById('config-notification-enabled').checked = config.notification_enabled || false;
            document.getElementById('config-notification-type').value = config.notification_type || '';
            document.getElementById('config-notification-endpoint').value = config.notification_endpoint || '';
            document.getElementById('config-recaptcha-site-key').value = config.recaptcha_site_key || '';
            document.getElementById('config-recaptcha-secret-key').value = config.recaptcha_secret_key || '';
            
            updateColorPreviews();
            toggleNotificationFields();
            previewImage('logo');
            previewImage('favicon');
        }
        
        function syncColorInput(type) {
            const picker = document.getElementById(`config-${type}-color-picker`);
            const input = document.getElementById(`config-${type}-color`);
            input.value = picker.value;
            updateColorPreviews();
        }
        
        function syncColorPicker(type) {
            const picker = document.getElementById(`config-${type}-color-picker`);
            const input = document.getElementById(`config-${type}-color`);
            if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(input.value)) {
                picker.value = input.value;
            }
            updateColorPreviews();
        }
        
        function updateColorPreviews() {
            const primary = document.getElementById('config-primary-color').value || '#1D4E4F';
            const secondary = document.getElementById('config-secondary-color').value || '#2D8B7A';
            const tertiary = document.getElementById('config-tertiary-color').value || '#5FB09C';
            
            document.getElementById('preview-primary').style.backgroundColor = primary;
            document.getElementById('preview-secondary').style.backgroundColor = secondary;
            document.getElementById('preview-tertiary').style.backgroundColor = tertiary;
        }
        
        function previewImage(type) {
            const input = document.getElementById(`config-${type}-url`);
            const preview = document.getElementById(`preview-${type}`);
            
            if (input.value) {
                preview.src = input.value;
                preview.style.display = 'block';
                preview.onerror = () => preview.style.display = 'none';
            } else {
                preview.style.display = 'none';
            }
        }
        
        function toggleNotificationFields() {
            const enabled = document.getElementById('config-notification-enabled').checked;
            document.getElementById('notification-fields').style.display = enabled ? 'block' : 'none';
        }
        
        async function saveConfig() {
            const data = {
                site_name: document.getElementById('config-site-name').value,
                primary_color: document.getElementById('config-primary-color').value || '#1D4E4F',
                secondary_color: document.getElementById('config-secondary-color').value || '#2D8B7A',
                tertiary_color: document.getElementById('config-tertiary-color').value || null,
                logo_url: document.getElementById('config-logo-url').value || null,
                favicon_url: document.getElementById('config-favicon-url').value || null,
                hero_title: document.getElementById('config-hero-title').value || null,
                hero_subtitle: document.getElementById('config-hero-subtitle').value || null,
                notification_enabled: document.getElementById('config-notification-enabled').checked,
                notification_type: document.getElementById('config-notification-type').value || null,
                notification_endpoint: document.getElementById('config-notification-endpoint').value || null,
                recaptcha_site_key: document.getElementById('config-recaptcha-site-key').value || null,
                recaptcha_secret_key: document.getElementById('config-recaptcha-secret-key').value || null,
                updated_at: new Date().toISOString()
            };
            
            if (!data.site_name) {
                showToast('El nombre del sitio es requerido', 'error');
                return;
            }
            
            try {
                let url, method;
                
                if (currentConfig && currentConfig.id) {
                    url = `${SUPABASE_CONFIG.url}/rest/v1/config?id=eq.${currentConfig.id}`;
                    method = 'PATCH';
                } else {
                    url = `${SUPABASE_CONFIG.url}/rest/v1/config`;
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'apikey': SUPABASE_CONFIG.anonKey,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (Array.isArray(result) && result.length > 0) currentConfig = result[0];
                    
                    showToast('Configuraci칩n guardada', 'success');
                    
                    if (data.site_name) {
                        document.getElementById('site-name').textContent = data.site_name;
                        document.getElementById('footer-name').textContent = data.site_name;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al guardar configuraci칩n', 'error');
            }
        }
        
        function resetConfig() {
            if (currentConfig) {
                populateConfigForm(currentConfig);
                showToast('Configuraci칩n restablecida', 'info');
            }
        }
    </script>

</body>
</html>

        
